<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.itwillbs.mapper.LectureMapper">
<!-- ?,?,? -> 대신 MemberVO 멤버변수 이름 작성 #{멤버변수이름} -->
<!--    <insert id="insertMember"> -->
<!--       insert into members(id,passwd,name,phone,email,gender,agree,content,rdate) -->
<!--       values(#{id},#{passwd},#{name},#{phone},#{email},#{gender},#{agree},#{content},#{rdate}) -->
<!--    </insert> -->
		
		<select id="getAllLectures" resultType="com.itwillbs.domain.LectureVO" parameterType="string">
		   	SELECT 
			    l.lecture_num,
			    l.user_num,
			    l.lecture_title,
			    l.lecture_author,
			    l.lecture_price,
			    l.category_detail,
			    l.lecture_img,
			    l.lecture_detail,
			    l.lecture_tag,
			    COALESCE(ROUND(AVG(r.review_score), 1), 0) AS avg_score,
			    COALESCE(COUNT(DISTINCT r.review_num), 0) AS review_count,
			    COALESCE(COUNT(DISTINCT e.enrollment_id), 0) AS student_count
			FROM 
			    lecture l
			    LEFT JOIN review r ON l.lecture_num = r.lecture_num
			    LEFT JOIN enrollment e ON l.lecture_num = e.lecture_num
			
			<where>
			    <if test="_parameter != null and _parameter != ''">
			       (   l.lecture_title LIKE CONCAT('%', #{_parameter}, '%')
			        OR l.lecture_author LIKE CONCAT('%', #{_parameter}, '%')
			        OR l.lecture_tag LIKE CONCAT('%', #{_parameter}, '%')
			        OR l.category_detail LIKE CONCAT('%', #{_parameter}, '%'))
			    </if>
			</where>
			
			GROUP BY 
			    l.lecture_num,
			    l.user_num,
			    l.lecture_title,
			    l.lecture_author,
			    l.lecture_price,
			    l.category_detail,
			    l.lecture_img,
			    l.lecture_detail,
			    l.lecture_tag
			ORDER BY 
			    l.lecture_tag DESC
		</select>
		
		<!-- 인기 강의 TOP 10 조회 (통계 포함) -->
		<select id="getTop10" resultType="com.itwillbs.domain.LectureVO">
		    SELECT 
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag,
		        COALESCE(ROUND(AVG(r.review_score), 1), 0) as avg_score,
		        COALESCE(COUNT(DISTINCT r.review_num), 0) as review_count,
		        COALESCE(COUNT(DISTINCT e.enrollment_id), 0) as student_count
		    FROM 
		        lecture l
		        LEFT JOIN review r ON l.lecture_num = r.lecture_num
		        LEFT JOIN enrollment e ON l.lecture_num = e.lecture_num
		    GROUP BY 
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag
		    ORDER BY 
		        review_count DESC
		    LIMIT 10
		</select>
		
		<select id="getLecturesByCategory" resultType="com.itwillbs.domain.LectureVO">
			SELECT 
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag,
		        COALESCE(ROUND(AVG(r.review_score), 1), 0) as avg_score,
		        COALESCE(COUNT(DISTINCT r.review_num), 0) as review_count,
		        COALESCE(COUNT(DISTINCT e.enrollment_id), 0) as student_count
		    FROM 
		        lecture l
		        LEFT JOIN review r ON l.lecture_num = r.lecture_num
		        LEFT JOIN enrollment e ON l.lecture_num = e.lecture_num
		    WHERE category_detail = #{category_detail}
		    GROUP BY 
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag
		    ORDER BY 
		        l.lecture_tag DESC
		</select>
		
		<select id="getTop10ByCategory" resultType="com.itwillbs.domain.LectureVO">
		    SELECT 
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag,
		        COALESCE(ROUND(AVG(r.review_score), 1), 0) as avg_score,
		        COALESCE(COUNT(DISTINCT r.review_num), 0) as review_count,
		        COALESCE(COUNT(DISTINCT e.enrollment_id), 0) as student_count
		    FROM 
		        lecture l
		        LEFT JOIN review r ON l.lecture_num = r.lecture_num
		        LEFT JOIN enrollment e ON l.lecture_num = e.lecture_num
		    WHERE category_detail = #{category_detail}
		    GROUP BY 
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag
		    ORDER BY 
		        l.lecture_tag DESC
		    LIMIT 10
		</select>

<!-- 		<select id="contentLecture" resultType="com.itwillbs.domain.LectureVO"> -->
<!-- 		    SELECT  -->
<!-- 		        l.*, -->
<!-- 		        IFNULL(e.student_count, 0) as student_count, -->
<!-- 		        IFNULL(t.total_time, '0시간 0분') as total_time -->
<!-- 		    FROM lecture l -->
<!-- 		    LEFT JOIN ( -->
<!-- 		        SELECT lecture_num, COUNT(DISTINCT user_num) as student_count -->
<!-- 		        FROM enrollment -->
<!-- 		        GROUP BY lecture_num -->
<!-- 		    ) e ON l.lecture_num = e.lecture_num -->
<!-- 		    LEFT JOIN ( -->
<!-- 		        SELECT  -->
<!-- 		            c.lecture_num, -->
<!-- 		            CONCAT( -->
<!-- 		                FLOOR(SUM( -->
<!-- 		                    CAST(SUBSTRING_INDEX(cd.detail_time, ':', 1) AS UNSIGNED) * 60 +  -->
<!-- 		                    CAST(SUBSTRING_INDEX(cd.detail_time, ':', -1) AS UNSIGNED) -->
<!-- 		                ) / 60 / 60),         -->
<!-- 		                '시간 ', -->
<!-- 		                FLOOR(SUM( -->
<!-- 		                    CAST(SUBSTRING_INDEX(cd.detail_time, ':', 1) AS UNSIGNED) * 60 +  -->
<!-- 		                    CAST(SUBSTRING_INDEX(cd.detail_time, ':', -1) AS UNSIGNED) -->
<!-- 		                ) / 60) % 60,         -->
<!-- 		                '분' -->
<!-- 		            ) AS total_time -->
<!-- 		        FROM chapter c -->
<!-- 		        INNER JOIN chapter_detail cd ON c.chapter_num = cd.chapter_num -->
<!-- 		        GROUP BY c.lecture_num -->
<!-- 		    ) t ON l.lecture_num = t.lecture_num -->
<!-- 		    WHERE l.lecture_num = #{lecture_num} -->
<!-- 		</select> -->

<select id="contentLecture" resultType="com.itwillbs.domain.LectureVO">
    SELECT 
        l.*,
        IFNULL(e.student_count, 0) as student_count,
        IFNULL(t.total_time, '0시간 0분') as total_time,
        IFNULL(r.avg_score, 0) as avg_score,
        IFNULL(r.review_count, 0) as review_count
    FROM lecture l
    LEFT JOIN (
        SELECT lecture_num, COUNT(DISTINCT user_num) as student_count
        FROM enrollment
        GROUP BY lecture_num
    ) e ON l.lecture_num = e.lecture_num
    LEFT JOIN (
        SELECT 
            c.lecture_num,
            CONCAT(
                FLOOR(SUM(
                    CAST(SUBSTRING_INDEX(cd.detail_time, ':', 1) AS UNSIGNED) * 60 + 
                    CAST(SUBSTRING_INDEX(cd.detail_time, ':', -1) AS UNSIGNED)
                ) / 60 / 60),        
                '시간 ',
                FLOOR(SUM(
                    CAST(SUBSTRING_INDEX(cd.detail_time, ':', 1) AS UNSIGNED) * 60 + 
                    CAST(SUBSTRING_INDEX(cd.detail_time, ':', -1) AS UNSIGNED)
                ) / 60) % 60,        
                '분'
            ) AS total_time
        FROM chapter c
        INNER JOIN chapter_detail cd ON c.chapter_num = cd.chapter_num
        GROUP BY c.lecture_num
    ) t ON l.lecture_num = t.lecture_num
    LEFT JOIN (
        SELECT 
            lecture_num,
            ROUND(AVG(review_score), 1) as avg_score,
            COUNT(*) as review_count
        FROM review
        GROUP BY lecture_num
    ) r ON l.lecture_num = r.lecture_num
    WHERE l.lecture_num = #{lecture_num}
</select>

  		
  		<select id="getUserImg" resultType="com.itwillbs.domain.UserVO">
  			select u.user_file, u.user_num
    		from lecture l
    		join user u on l.user_num = u.user_num
    		where l.lecture_num = #{lecture_num}
  		</select>
  		
		<select id="authorLectures" resultType="com.itwillbs.domain.LectureVO">
		    SELECT 
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag,
		        COALESCE(ROUND(AVG(r.review_score), 1), 0) as avg_score,
		        COALESCE(COUNT(DISTINCT r.review_num), 0) as review_count,
		        COALESCE(COUNT(DISTINCT e.enrollment_id), 0) as student_count
		    FROM 
		        lecture l
		        LEFT JOIN review r ON l.lecture_num = r.lecture_num
		        LEFT JOIN enrollment e ON l.lecture_num = e.lecture_num
		    WHERE 
		        l.lecture_author = #{lecture_author}
		        AND l.lecture_num != #{lecture_num}
		    GROUP BY 
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag
		    ORDER BY 
		        l.lecture_tag DESC
		    LIMIT 4
		</select>
		
		<select id="similarLectures" resultType="com.itwillbs.domain.LectureVO">
		    SELECT 
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag,
		        COALESCE(ROUND(AVG(r.review_score), 1), 0) as avg_score,
		        COALESCE(COUNT(DISTINCT r.review_num), 0) as review_count,
		        COALESCE(COUNT(DISTINCT e.enrollment_id), 0) as student_count
		    FROM 
		        lecture l
		        LEFT JOIN review r ON l.lecture_num = r.lecture_num
		        LEFT JOIN enrollment e ON l.lecture_num = e.lecture_num
		    WHERE 
		        l.lecture_num != #{lecture_num}
		        <if test="tagList != null and tagList.size() > 0">
		            AND (
		                <foreach collection="tagList" item="tag" separator=" OR ">
		                    l.lecture_tag LIKE CONCAT('%', #{tag}, '%')
		                </foreach>
		            )
		        </if>
		    GROUP BY                           
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag
		    ORDER BY 
		        l.lecture_tag DESC
		    LIMIT 4
		</select>
		
		
		<select id="getDetail" resultType="com.itwillbs.domain.ChapterDetailVO">
		   	select * from chapter_detail
		   	where chapter_num = #{chapter_num}
		   	order by detail_order
		</select>
		
		<select id="getChapterList" resultType="com.itwillbs.domain.ChapterVO">
		   	select * from chapter
		   	where lecture_num = #{lecture_num}
		   	order by chapter_order
		</select>
		
		<select id="getReviewList" resultType="com.itwillbs.domain.ReviewVO">
		   	SELECT 
		        r.review_num,
		        r.lecture_num,
		        r.user_id,
		        r.review_score,
		        r.review_content,
		        u.user_name,                    
		        (SELECT COUNT(*) 
		         FROM review 
		         WHERE user_id = r.user_id) as review_count,    
		        (SELECT ROUND(AVG(review_score), 1) 
		         FROM review 
		         WHERE user_id = r.user_id) as avg_score        
		    FROM review r
		    INNER JOIN user u ON r.user_id = u.user_id          
		    WHERE r.lecture_num = #{lecture_num}
		    ORDER BY r.review_score DESC
		</select>
		
		<select id="getUserNum" resultType="int">
		    SELECT user_num
		    FROM user
		    WHERE user_id = #{user_id}
		</select>
		
		<select id="hasPurchased" resultType="int">
		    SELECT COUNT(*)
		    FROM enrollment
		    WHERE user_num = #{user_num}
		    AND lecture_num = #{lecture_num}
		</select>
   		 <!-- ===============================
           특정 강의 상세 조회
         - payment_detail 저장용
         - 강의 가격, 제목, 썸네일 등
       =============================== -->
	    
	    <select id="getLectureById" parameterType="int" resultType="com.itwillbs.domain.LectureVO">
		    SELECT
		        lecture_num,
		        user_num,
		        lecture_title,
		        lecture_author,
		        lecture_price,
		        category_detail,
		        lecture_img,
		        lecture_detail,
		        lecture_tag
		    FROM lecture
		    WHERE lecture_num = #{lecture_num}
		</select>
		
		<insert id="insertReview">
	       insert into review(user_id, lecture_num, review_score, review_content)
	       values(#{user_id},#{lecture_num},#{review_score},#{review_content})
	    </insert>
	    
	    <select id="hasWrittenReview" resultType="java.lang.Integer">
		    SELECT COUNT(*)
		    FROM review
		    WHERE user_id = #{user_id}
		    AND lecture_num = #{lecture_num}
		</select>
		
		<select id="getRecoLectures" resultType="com.itwillbs.domain.LectureVO" parameterType="int">
		    WITH user_tags AS (
		        SELECT DISTINCT TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(l.lecture_tag, ',', numbers.n), ',', -1)) AS tag
		        FROM enrollment e
		        JOIN lecture l ON e.lecture_num = l.lecture_num
		        JOIN (
		            SELECT 1 n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5
		            UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
		        ) numbers ON CHAR_LENGTH(l.lecture_tag) - CHAR_LENGTH(REPLACE(l.lecture_tag, ',', '')) >= numbers.n - 1
		        WHERE e.user_num = #{user_num}
		    ),
		    scrap_tags AS (
		        SELECT DISTINCT TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(l.lecture_tag, ',', numbers.n), ',', -1)) AS tag
		        FROM scrap s
		        JOIN lecture l ON s.lecture_num = l.lecture_num
		        JOIN (
		            SELECT 1 n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5
		            UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10
		        ) numbers ON CHAR_LENGTH(l.lecture_tag) - CHAR_LENGTH(REPLACE(l.lecture_tag, ',', '')) >= numbers.n - 1
		        WHERE s.user_num = #{user_num}
		    )
		    SELECT
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag,
		        COALESCE(ROUND(AVG(r.review_score), 1), 0) AS avg_score,
		        COALESCE(COUNT(DISTINCT r.review_num), 0) AS review_count,
		        COALESCE(COUNT(DISTINCT e2.enrollment_id), 0) AS student_count,
		        (
		            SELECT COUNT(*) FROM user_tags ut WHERE FIND_IN_SET(ut.tag, l.lecture_tag)
		        ) +
		        (
		            SELECT COUNT(*) FROM scrap_tags st WHERE FIND_IN_SET(st.tag, l.lecture_tag)
		        ) AS match_count
		    FROM lecture l
		    LEFT JOIN review r ON l.lecture_num = r.lecture_num
		    LEFT JOIN enrollment e2 ON l.lecture_num = e2.lecture_num
		    WHERE l.lecture_num NOT IN (
		        SELECT lecture_num FROM enrollment WHERE user_num = #{user_num}
		    )
		    GROUP BY
		        l.lecture_num,
		        l.user_num,
		        l.lecture_title,
		        l.lecture_author,
		        l.lecture_price,
		        l.category_detail,
		        l.lecture_img,
		        l.lecture_detail,
		        l.lecture_tag
		    ORDER BY
		        match_count DESC
		</select>

        

		
</mapper>
  