<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminReportMapper">

    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ëª©ë¡ ì¡°íšŒ (ê²Œì‹œê¸€ + ëŒ“ê¸€)            -->
    <!-- ========================================= -->
    <select id="getReportList" resultType="com.itwillbs.domain.AdminReportVO">
        SELECT
            r.report_id,
            r.post_id,
            r.comment_id,
            r.user_num,
            r.reason,
            r.created_at,
            r.is_done,
            r.action,
            r.admin_reason,
            r.done_at,

            u.user_id,
            u.user_name,

            p.title AS post_title,
            c.content AS comment_content

        FROM report r
        LEFT JOIN user u ON r.user_num = u.user_num
        LEFT JOIN community_content p ON r.post_id = p.post_id
        LEFT JOIN comment c ON r.comment_id = c.comment_id
        WHERE 1 = 1

        <!-- ðŸ”Ž ìœ í˜• í•„í„° -->
        <if test="type == 'post'"> AND r.post_id IS NOT NULL </if>
        <if test="type == 'comment'"> AND r.comment_id IS NOT NULL </if>

        <!-- ðŸ”Ž ìƒíƒœ í•„í„° -->
        <if test="status == 'wait'"> AND r.is_done = 0 </if>
        <if test="status == 'done'"> AND r.is_done = 1 </if>

        ORDER BY r.report_id DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ì´ ê°œìˆ˜ (í•„í„° ë™ì¼ ì ìš©)            -->
    <!-- ========================================= -->
    <select id="getReportCount" resultType="int">
        SELECT COUNT(*)
        FROM report r
        WHERE 1 = 1

        <!-- ìœ í˜• í•„í„° -->
        <if test="type == 'post'"> AND r.post_id IS NOT NULL </if>
        <if test="type == 'comment'"> AND r.comment_id IS NOT NULL </if>

        <!-- ìƒíƒœ í•„í„° -->
        <if test="status == 'wait'"> AND r.is_done = 0 </if>
        <if test="status == 'done'"> AND r.is_done = 1 </if>
    </select>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ìƒì„¸ ì¡°íšŒ                          -->
    <!-- ========================================= -->
    <select id="getReportDetail" resultType="com.itwillbs.domain.AdminReportVO">
        SELECT
            r.report_id,
            r.post_id,
            r.comment_id,
            r.user_num,
            r.reason,
            r.created_at,
            r.is_done,
            r.action,
            r.admin_reason,
            r.done_at,

            u.user_id,
            u.user_name,

            p.title AS post_title,
            p.content AS post_content,

            c.content AS comment_content

        FROM report r
        LEFT JOIN user u ON r.user_num = u.user_num
        LEFT JOIN community_content p ON r.post_id = p.post_id
        LEFT JOIN comment c ON r.comment_id = c.comment_id
        WHERE r.report_id = #{report_id}
    </select>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ì²˜ë¦¬                              -->
    <!-- ========================================= -->
    <update id="updateReportDone">
        UPDATE report
        SET 
            is_done = 1,
            action = 'ACCEPT',
            admin_reason = #{done_reason},
            done_at = NOW()
        WHERE report_id = #{report_id}
    </update>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ë°˜ë ¤                              -->
    <!-- ========================================= -->
    <update id="rejectReport">
        UPDATE report
        SET 
            is_done = 2,
            action = 'REJECT',
            admin_reason = #{reason},
            done_at = NOW()
        WHERE report_id = #{report_id}
    </update>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ìƒë‹¨ í†µê³„ â€” í•„í„° ì ìš©ëœ ë²„ì „ 4ì¢…        -->
    <!-- ========================================= -->

    <!-- ì „ì²´ ì‹ ê³  -->
    <select id="getTotalCountFiltered" resultType="int">
        SELECT COUNT(*) FROM report
    </select>

    <!-- ì´ë²ˆë‹¬ ì‹ ê³  -->
    <select id="getMonthCountFiltered" resultType="int">
        SELECT COUNT(*)
        FROM report
        WHERE DATE_FORMAT(created_at, '%Y-%m') = DATE_FORMAT(NOW(), '%Y-%m')
    </select>

    <!-- ê²Œì‹œê¸€ ì‹ ê³  -->
    <select id="getPostCountFiltered" resultType="int">
        SELECT COUNT(*) FROM report WHERE post_id IS NOT NULL
    </select>

    <!-- ëŒ“ê¸€ ì‹ ê³  -->
    <select id="getCommentCountFiltered" resultType="int">
        SELECT COUNT(*) FROM report WHERE comment_id IS NOT NULL
    </select>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ì²˜ë¦¬ ë¡œê·¸ ê¸°ë¡                     -->
    <!-- ========================================= -->
    <insert id="insertReportActionLog">
        INSERT INTO report_action_log (report_id, admin_id, action, reason)
        VALUES (#{report_id}, #{admin_id}, #{action}, #{reason})
    </insert>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ì²˜ë¦¬ ë¡œê·¸ ì¡°íšŒ                     -->
    <!-- ========================================= -->
    <select id="getReportActionLogs" 
            resultType="com.itwillbs.domain.ReportActionLogVO">
        SELECT
            log_id,
            report_id,
            admin_id,
            action,
            reason,
            created_at
        FROM report_action_log
        WHERE report_id = #{report_id}
        ORDER BY log_id DESC
    </select>

</mapper>
