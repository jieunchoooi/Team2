<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminReportMapper">

    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ëª©ë¡ ì¡°íšŒ (ê²Œì‹œê¸€ + ëŒ“ê¸€)           -->
    <!-- ========================================= -->
    <select id="getReportList" resultType="com.itwillbs.domain.AdminReportVO">
        SELECT
        r.report_id,
        r.post_id,
        r.comment_id,
        r.reporter_id,
        r.reason,
        r.created_at,
        r.is_done,

        p.title AS post_title,
        c.content AS comment_content

        FROM community_report r
        LEFT JOIN community_content p
        ON r.post_id = p.post_id
        LEFT JOIN community_comment c
        ON r.comment_id = c.comment_id

        WHERE 1 = 1

        <!-- ìœ í˜• í•„í„° -->
        <if test="type != null and type != ''">
            <if test="type == 'post'">
                AND r.post_id IS NOT NULL
            </if>
            <if test="type == 'comment'">
                AND r.comment_id IS NOT NULL
            </if>
        </if>

        <!-- ì²˜ë¦¬ ìƒíƒœ í•„í„° -->
        <if test="status != null and status != ''">
            <if test="status == 'wait'">
                AND r.is_done = 0
            </if>
            <if test="status == 'done'">
                AND r.is_done = 1
            </if>
        </if>

        ORDER BY r.report_id DESC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ìƒì„¸ ì¡°íšŒ                           -->
    <!-- ========================================= -->
    <select id="getReportDetail" resultType="com.itwillbs.domain.AdminReportVO">
        SELECT
        r.report_id,
        r.post_id,
        r.comment_id,
        r.reporter_id,
        r.reason,
        r.created_at,
        r.is_done,
        r.done_at,
        r.done_reason,

        -- ê²Œì‹œê¸€ JOIN
        p.title AS post_title,
        p.content AS post_content,

        -- ëŒ“ê¸€ JOIN
        c.content AS comment_content

        FROM community_report r
        LEFT JOIN community_content p
        ON r.post_id = p.post_id
        LEFT JOIN community_comment c
        ON r.comment_id = c.comment_id

        WHERE r.report_id = #{report_id}
    </select>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ì²˜ë¦¬ ì™„ë£Œ                           -->
    <!-- ========================================= -->
    <update id="updateReportDone">
        UPDATE community_report
        SET is_done = 1,
        done_at = NOW(),
        done_reason = #{done_reason}
        WHERE report_id = #{report_id}
    </update>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ë°˜ë ¤                                -->
    <!-- ========================================= -->
    <update id="rejectReport">
        UPDATE community_report
        SET is_done = 2,
        done_at = NOW(),
        done_reason = #{reason}
        WHERE report_id = #{report_id}
    </update>


    <!-- ========================================= -->
    <!-- ðŸ“Œ íŽ˜ì´ì§•ìš© ì´ ê°œìˆ˜ ì¡°íšŒ                   -->
    <!-- ========================================= -->
    <select id="getReportCount" resultType="int">
        SELECT COUNT(*)
        FROM community_report r
        WHERE 1 = 1

        <if test="type != null and type != ''">
            <if test="type == 'post'">
                AND r.post_id IS NOT NULL
            </if>
            <if test="type == 'comment'">
                AND r.comment_id IS NOT NULL
            </if>
        </if>

        <if test="status != null and status != ''">
            <if test="status == 'wait'">
                AND r.is_done = 0
            </if>
            <if test="status == 'done'">
                AND r.is_done = 1
            </if>
        </if>
    </select>


    <!-- ========================================= -->
    <!-- ðŸ“Œ í†µê³„                                     -->
    <!-- ========================================= -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*) FROM community_report
    </select>

    <select id="getMonthCount" resultType="int">
        SELECT COUNT(*)
        FROM community_report
        WHERE MONTH(created_at) = MONTH(NOW())
    </select>

    <select id="getPostCount" resultType="int">
        SELECT COUNT(*)
        FROM community_report
        WHERE post_id IS NOT NULL
    </select>

    <select id="getCommentCount" resultType="int">
        SELECT COUNT(*)
        FROM community_report
        WHERE comment_id IS NOT NULL
    </select>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ì²˜ë¦¬ ë¡œê·¸ ì €ìž¥                     -->
    <!-- ========================================= -->
    <insert id="insertReportActionLog">
        INSERT INTO report_action_log (report_id, admin_id, action, reason)
        VALUES (#{report_id}, #{admin_id}, #{action}, #{reason})
    </insert>


    <!-- ========================================= -->
    <!-- ðŸ“Œ ì‹ ê³  ì²˜ë¦¬ ë¡œê·¸ ì¡°íšŒ                     -->
    <!-- ========================================= -->
    <select id="getReportActionLogs"
            resultType="com.itwillbs.domain.ReportActionLogVO">
        SELECT
        log_id,
        report_id,
        admin_id,
        action,
        reason,
        created_at
        FROM report_action_log
        WHERE report_id = #{report_id}
        ORDER BY log_id DESC
    </select>

</mapper>
