<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminReportMapper">

    <!-- 신고 목록 조회 (게시글/댓글 포함) -->
    <select id="getReportList" resultType="com.itwillbs.domain.AdminReportVO">

        SELECT
        r.report_id,
        r.post_id,
        r.comment_id,
        r.reporter_id,
        r.reason,
        r.created_at,
        r.is_done,
        p.title AS post_title,
        c.content AS comment_content
        FROM report r
        LEFT JOIN community_content p ON r.post_id = p.post_id
        LEFT JOIN comment c ON r.comment_id = c.comment_id
        WHERE 1=1

        <!-- 유형 필터 -->
        <if test="type != null and type != ''">
            <if test="type == 'post'">
                AND r.post_id IS NOT NULL
            </if>
            <if test="type == 'comment'">
                AND r.comment_id IS NOT NULL
            </if>
        </if>

        <!-- 상태 필터 -->
        <if test="status != null and status != ''">
            <if test="status == 'wait'">
                AND r.is_done = 0
            </if>
            <if test="status == 'done'">
                AND r.is_done = 1
            </if>
        </if>

        ORDER BY r.report_id DESC
        LIMIT #{pageSize} OFFSET #{offset}

    </select>


    <!-- 신고 단건 상세 조회 -->
    <select id="getReportDetail" resultType="com.itwillbs.domain.AdminReportVO">
        SELECT
        r.report_id,
        r.post_id,
        r.comment_id,
        r.reporter_id,
        r.reason,
        r.created_at,
        r.is_done,
        r.done_at,
        r.done_reason,

        -- 게시글 원문
        p.title AS post_title,
        p.content AS post_content,

        -- 댓글 원문
        c.content AS comment_content

        FROM report r
        LEFT JOIN community_content p ON r.post_id = p.post_id
        LEFT JOIN comment c ON r.comment_id = c.comment_id

        WHERE r.report_id = #{report_id}
    </select>


    <!-- 신고 처리 완료 -->
    <update id="updateReportDone">
        UPDATE report
        SET is_done = 1,
        done_at = NOW(),
        done_reason = #{done_reason}
        WHERE report_id = #{report_id}
    </update>



    <select id="getReportCount" resultType="int">
        SELECT COUNT(*)
        FROM report r
        WHERE 1=1

        <!-- 유형 필터 -->
        <if test="type != null and type != ''">
            <if test="type == 'post'">
                AND r.post_id IS NOT NULL
            </if>
            <if test="type == 'comment'">
                AND r.comment_id IS NOT NULL
            </if>
        </if>

        <!-- 상태 필터 -->
        <if test="status != null and status != ''">
            <if test="status == 'wait'">
                AND r.is_done = 0
            </if>
            <if test="status == 'done'">
                AND r.is_done = 1
            </if>
        </if>
    </select>

    <!-- 전체 신고 수 -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*) FROM report
    </select>

    <!-- 이번 달 신고 수 -->
    <select id="getMonthCount" resultType="int">
        SELECT COUNT(*)
        FROM report
        WHERE MONTH(created_at) = MONTH(NOW())
    </select>

    <!-- 게시글 신고 수 -->
    <select id="getPostCount" resultType="int">
        SELECT COUNT(*)
        FROM report
        WHERE post_id IS NOT NULL
    </select>

    <!-- 댓글 신고 수 -->
    <select id="getCommentCount" resultType="int">
        SELECT COUNT(*)
        FROM report
        WHERE comment_id IS NOT NULL
    </select>

    <!-- 신고 처리 로그 저장 -->
    <insert id="insertReportActionLog">
        INSERT INTO report_action_log (report_id, admin_id, action, reason)
        VALUES (#{report_id}, #{admin_id}, #{action}, #{reason})
    </insert>

    <!-- 신고 처리 로그 조회 -->
    <select id="getReportActionLogs" resultType="com.itwillbs.domain.ReportActionLogVO">
        SELECT
        log_id,
        report_id,
        admin_id,
        action,
        reason,
        created_at
        FROM report_action_log
        WHERE report_id = #{report_id}
        ORDER BY log_id DESC
    </select>

    <!-- 신고 반려 -->
    <update id="rejectReport">
        UPDATE report
        SET is_done = 2,
        done_at = NOW(),
        done_reason = #{reason}
        WHERE report_id = #{report_id}
    </update>

</mapper>
