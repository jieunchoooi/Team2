<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.UserMapper">

    <!-- âœ… íšŒì› ê°€ìž… -->
    <insert id="insertUser" parameterType="com.itwillbs.domain.UserVO">
        INSERT INTO user (
        user_id,
        user_password,
        user_name,
        user_phone,
        user_email,
        user_zipcode,
        user_address1,
        user_address2,
        user_gender,
        user_file,
        user_role,
        user_status,
        grade_id,
        points
        )
        VALUES (
        #{user_id},
        #{user_password},
        #{user_name},
        #{user_phone},
        #{user_email},
        #{user_zipcode},
        #{user_address1},
        #{user_address2},
        #{user_gender},
        #{user_file},
        #{user_role},
        'active',
        1,
        0
        )
    </insert>

    <!-- âœ… ë¡œê·¸ì¸ -->
    <select id="loginUser" parameterType="com.itwillbs.domain.UserVO"
            resultType="com.itwillbs.domain.UserVO">
        SELECT *
        FROM user
        WHERE user_id = #{user_id}
    </select>

    <!-- ì•„ì´ë””ë¡œ íšŒì› ì¡°íšŒ -->
    <select id="selectUserById" parameterType="String" resultType="com.itwillbs.domain.UserVO">
        SELECT *
        FROM user
        WHERE user_id = #{user_id}
    </select>

    <!-- ì´ë©”ì¼ë¡œ ì‚¬ìš©ìž ì°¾ê¸° -->
    <select id="findUserByEmail" resultType="com.itwillbs.domain.UserVO">
        SELECT *
        FROM user
        WHERE user_email = #{user_email}
    </select>

    <!-- ì•„ì´ë”” + ì´ë©”ì¼ë¡œ íšŒì› ì¡°íšŒ -->
    <select id="findUserByIdAndEmail" resultType="com.itwillbs.domain.UserVO">
        SELECT *
        FROM user
        WHERE user_id = #{user_id}
        AND user_email = #{user_email}
    </select>

    <!-- ìž„ì‹œ ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸ -->
    <update id="updateTempPassword">
        UPDATE user
        SET user_password = #{tempPw}
        WHERE user_id = #{user_id}
    </update>

    <!-- ì´ë©”ì¼ ì¤‘ë³µ ê²€ì‚¬ -->
    <select id="checkEmail" parameterType="String" resultType="int">
        SELECT COUNT(*)
        FROM user
        WHERE user_email = #{user_email}
    </select>

    <!-- ì´ë¦„ + ì´ë©”ì¼ë¡œ ì•„ì´ë”” ì°¾ê¸° -->
    <select id="findIdByNameAndEmail" resultType="com.itwillbs.domain.UserVO">
        SELECT *
        FROM user
        WHERE user_name = #{user_name}
        AND user_email = #{user_email}
    </select>



    <!-- íšŒì› ì •ë³´ ì¡°íšŒ -->
    <select id="getUserByNum" parameterType="int" resultType="com.itwillbs.domain.UserVO">
        SELECT
        user_num,
        user_id,
        user_password,
        user_name,
        user_phone,
        user_email,
        user_zipcode,
        user_address1,
        user_address2,
        user_gender,
        user_role,
        user_status,
        grade_id,
        points,
        user_file,
        created_at,
        updated_at
        FROM user
        WHERE user_num = #{user_num}
    </select>

    <!-- í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸ -->
    <update id="updateUserPoints" parameterType="com.itwillbs.domain.UserVO">
        UPDATE user
        SET points = #{points},
        updated_at = NOW()
        WHERE user_num = #{user_num}
    </update>

    <!-- ë“±ê¸‰ ì—…ë°ì´íŠ¸ -->
    <update id="updateUserGrade" parameterType="com.itwillbs.domain.UserVO">
        UPDATE user
        SET grade_id = #{grade_id},
        updated_at = NOW()
        WHERE user_num = #{user_num}
    </update>

    <!-- =======================================
         ðŸ”¹ ìœ ì € ë³´ìœ  í¬ì¸íŠ¸ ì¡°íšŒ
         ======================================= -->
    <select id="getUserPoints" parameterType="int" resultType="int">
        SELECT points
        FROM user
        WHERE user_num = #{userNum}
    </select>

    <!-- ë¡œê·¸ì¸ ì‹¤íŒ¨ íšŸìˆ˜ ì¦ê°€ -->
    <update id="increaseFailCount">
        UPDATE user
        SET
        login_fail_count = login_fail_count + 1,
        last_fail_time = NOW()
        WHERE user_id = #{user_id}
    </update>

    <!-- ë¡œê·¸ì¸ ì‹¤íŒ¨ íšŸìˆ˜ ì´ˆê¸°í™” -->
    <update id="resetFailCount">
        UPDATE user
        SET
        login_fail_count = 0,
        last_fail_time = NULL
        WHERE user_id = #{user_id}
    </update>

    <!-- ê°•ì œ ê³„ì • ìž ê¸ˆ -->
    <update id="lockUser">
        UPDATE user
        SET
        login_fail_count = 5,
        last_fail_time = NOW()
        WHERE user_id = #{user_id}
    </update>

    <!-- ë§ˆì§€ë§‰ ë¡œê·¸ì¸ ì‹œê°„ ì—…ë°ì´íŠ¸ -->
    <update id="updateLastLoginTime">
        UPDATE user
        SET last_login_at = NOW()
        WHERE user_id = #{user_id}
    </update>

    <update id="updatePasswordUpdatedAt">
        UPDATE user
        SET password_updated_at = NOW()
        WHERE user_id = #{user_id}
    </update>

</mapper>