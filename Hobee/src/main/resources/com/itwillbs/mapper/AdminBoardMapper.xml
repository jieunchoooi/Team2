<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminBoardMapper">

    <!-- ========================================================= -->
    <!-- üìå RESULT MAP : Í≤åÏãúÌåê ÏÉÅÏÑ∏ Ï°∞Ìöå Ïãú VO ÏûêÎèô Îß§ÌïëÏö©          -->
    <!-- ========================================================= -->
    <resultMap id="boardMap" type="com.itwillbs.domain.AdminBoardVO">

        <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ -->
        <id property="board_id" column="board_id"/>
        <result property="board_name" column="board_name"/>
        <result property="board_desc" column="board_desc"/>
        <result property="is_active" column="is_active"/>
        <result property="created_at" column="created_at"/>
        <result property="board_order" column="board_order"/>

        <!-- ÌÜµÍ≥Ñ Ï†ïÎ≥¥ -->
        <result property="post_count" column="post_count"/>
        <result property="post_count_month" column="post_count_month"/>
        <result property="post_count_visible" column="post_count_visible"/>
        <result property="report_count" column="report_count"/>

        <!-- ÏòµÏÖò Ï†ïÎ≥¥ -->
        <result property="allow_comment" column="allow_comment"/>
        <result property="allow_image" column="allow_image"/>
        <result property="allow_file" column="allow_file"/>
        <result property="write_role" column="write_role"/>
        <result property="banned_words" column="banned_words"/>
        <result property="require_approval" column="require_approval"/>

    </resultMap>



    <!-- ========================================================= -->
    <!-- 1) Í≤åÏãúÌåê Î™©Î°ù Ï°∞Ìöå (Ï†ïÎ†¨ ÏàúÏÑú Ìè¨Ìï®)                        -->
    <!-- ========================================================= -->
    <select id="getBoardList" resultType="com.itwillbs.domain.AdminBoardVO">
        SELECT
            b.board_id,
            b.board_name,
            b.board_desc,
            b.is_active,
            b.created_at,
            b.board_order,

            /* Í≤åÏãúÌåêÎ≥Ñ Í≤åÏãúÍ∏Ä Ïàò */
            (SELECT COUNT(*)
             FROM community_content c
             WHERE c.category_id = b.board_id) AS post_count

        FROM board_category b
        ORDER BY board_order ASC
    </select>



    <!-- ========================================================= -->
    <!-- 2) Í≤åÏãúÌåê Îã®Ïùº Ï°∞Ìöå (ÏàòÏ†ï ÌôîÎ©¥Ïö©)                           -->
    <!-- ========================================================= -->
    <select id="getBoard" resultType="com.itwillbs.domain.AdminBoardVO" parameterType="int">
        SELECT
            board_id,
            board_name,
            board_desc,
            is_active,
            created_at,
            board_order,

            /* ÏòµÏÖò */
            allow_comment,
            allow_image,
            allow_file,
            write_role,
            banned_words,
            require_approval

        FROM board_category
        WHERE board_id = #{board_id}
    </select>



    <!-- ========================================================= -->
    <!-- 3) Í≤åÏãúÌåê ÏÉÅÏÑ∏ + ÌÜµÍ≥Ñ Ï°∞Ìöå (ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄ Ï†ÑÏö©)               -->
    <!-- ========================================================= -->
    <select id="getBoardDetail" parameterType="int" resultType="com.itwillbs.domain.AdminBoardVO">

        SELECT
            b.board_id,
            b.board_name,
            b.board_desc,
            b.is_active,
            b.created_at,
            b.board_order,

            b.allow_comment,
            b.allow_image,
            b.allow_file,
            b.write_role,
            b.banned_words,
            b.require_approval,

            /* Ï†ÑÏ≤¥ Í∏Ä Ïàò */
            (SELECT COUNT(*)
             FROM community_content c
             WHERE c.category_id = b.board_id) AS post_count,

            /* Ïù¥Î≤àÎã¨ Í∏Ä Ïàò */
            (SELECT COUNT(*)
             FROM community_content c
             WHERE c.category_id = b.board_id
             AND c.created_at >= DATE_FORMAT(NOW(), '%Y-%m-01')) AS post_count_month,

            /* ÏÇ≠Ï†úÎêòÏßÄ ÏïäÏùÄ Í∏Ä */
            (SELECT COUNT(*)
             FROM community_content c
             WHERE c.category_id = b.board_id
             AND c.is_deleted = 0) AS post_count_visible,

            /* Ïã†Í≥†Îêú Í∏Ä Ïàò */
            (SELECT COUNT(*)
             FROM report r
             JOIN community_content c ON r.post_id = c.post_id
             WHERE c.category_id = b.board_id) AS report_count

        FROM board_category b
        WHERE b.board_id = #{board_id}
    </select>



    <!-- ========================================================= -->
    <!-- 4) ÏµúÍ∑º Í≤åÏãúÍ∏Ä 5Í∞ú Ï°∞Ìöå                                     -->
    <!-- ========================================================= -->
    <select id="getRecentPosts" parameterType="int" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT
            post_id,
            title,
            user_num,
            created_at,
            is_deleted
        FROM community_content
        WHERE category_id = #{board_id}
        ORDER BY created_at DESC
        LIMIT 5
    </select>



    <!-- ========================================================= -->
    <!-- 5) Ï°∞ÌöåÏàò TOP5 Í≤åÏãúÍ∏Ä Ï°∞Ìöå                                  -->
    <!-- ========================================================= -->
    <select id="getTopViewPosts" parameterType="int" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT
            post_id,
            title,
            views,
            0 AS report_count   /* ÌÜµÏùºÏÑ±ÏùÑ ÏúÑÌïú ÎçîÎØ∏ Í∞í */
        FROM community_content
        WHERE category_id = #{board_id}
        ORDER BY views DESC
        LIMIT 5
    </select>



    <!-- ========================================================= -->
    <!-- 6) Ïã†Í≥† ÎßéÏùÄ Í∏Ä TOP 5 Ï°∞Ìöå                                  -->
    <!-- ========================================================= -->
    <select id="getTopReportPosts" parameterType="int" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT
            c.post_id,
            c.title,
            c.views,
            COUNT(*) AS report_count
        FROM report r
        JOIN community_content c ON r.post_id = c.post_id
        WHERE c.category_id = #{board_id}
        GROUP BY c.post_id, c.title, c.views
        ORDER BY report_count DESC
        LIMIT 5
    </select>



    <!-- ========================================================= -->
    <!-- 7) ÏµúÍ∑º 7Ïùº Í≤åÏãúÍ∏Ä Ï¶ùÍ∞ÄÎüâ (Í∑∏ÎûòÌîÑÏö©)                        -->
    <!-- ========================================================= -->
    <select id="getWeeklyPostStats" parameterType="int" resultType="map">
        SELECT
            DATE(created_at) AS day,
            COUNT(*) AS count
        FROM community_content
        WHERE category_id = #{board_id}
        AND created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
        GROUP BY DATE(created_at)
        ORDER BY day ASC
    </select>



    <!-- ========================================================= -->
    <!-- 8) Í≤åÏãúÌåê ÏÉùÏÑ±                                              -->
    <!-- ========================================================= -->
    <insert id="insertBoard" parameterType="com.itwillbs.domain.AdminBoardVO">
        INSERT INTO board_category
            (board_name, board_desc, is_active, created_at, board_order,
             allow_comment, allow_image, allow_file, write_role, banned_words, require_approval)
        VALUES
            (#{board_name}, #{board_desc}, #{is_active}, NOW(), 9999,
             #{allow_comment}, #{allow_image}, #{allow_file}, #{write_role}, #{banned_words}, #{require_approval})
    </insert>



    <!-- ========================================================= -->
    <!-- 9) Í≤åÏãúÌåê ÏàòÏ†ï                                              -->
    <!-- ========================================================= -->
    <update id="updateBoard" parameterType="com.itwillbs.domain.AdminBoardVO">
        UPDATE board_category
        SET
            board_name       = #{board_name},
            board_desc       = #{board_desc},
            is_active        = #{is_active},
            allow_comment    = #{allow_comment},
            allow_image      = #{allow_image},
            allow_file       = #{allow_file},
            write_role       = #{write_role},
            banned_words     = #{banned_words},
            require_approval = #{require_approval}
        WHERE board_id = #{board_id}
    </update>



    <!-- ========================================================= -->
    <!-- 10) Í≤åÏãúÌåê ÌëúÏãú/Ïà®ÍπÄ                                        -->
    <!-- ========================================================= -->
    <update id="disableBoard" parameterType="int">
        UPDATE board_category SET is_active = 0 WHERE board_id = #{board_id}
    </update>

    <update id="enableBoard" parameterType="int">
        UPDATE board_category SET is_active = 1 WHERE board_id = #{board_id}
    </update>



    <!-- ========================================================= -->
    <!-- 11) Í≤åÏãúÌåê ÏàúÏÑú Î≥ÄÍ≤Ω                                        -->
    <!-- ========================================================= -->
    <update id="updateBoardOrder" parameterType="com.itwillbs.domain.AdminBoardVO">
        UPDATE board_category
        SET board_order = #{board_order}
        WHERE board_id = #{board_id}
    </update>



    <!-- ========================================================= -->
    <!-- 12) Í≤åÏãúÌåê ÏòµÏÖò Î≥ÄÍ≤Ω (ÎåìÍ∏Ä/Ïù¥ÎØ∏ÏßÄ/ÌååÏùº/ÏäπÏù∏)                -->
    <!-- ========================================================= -->
    <update id="updateAllowComment" parameterType="map">
        UPDATE board_category SET allow_comment = #{value} WHERE board_id = #{board_id}
    </update>

    <update id="updateAllowImage" parameterType="map">
        UPDATE board_category SET allow_image = #{value} WHERE board_id = #{board_id}
    </update>

    <update id="updateAllowFile" parameterType="map">
        UPDATE board_category SET allow_file = #{value} WHERE board_id = #{board_id}
    </update>

    <update id="updateRequireApproval" parameterType="map">
        UPDATE board_category SET require_approval = #{value} WHERE board_id = #{board_id}
    </update>



    <!-- ========================================================= -->
    <!-- 13) Í≤åÏãúÌåê ÏÇ≠Ï†ú (Î¨ºÎ¶¨ ÏÇ≠Ï†ú)                                 -->
    <!-- ========================================================= -->
    <delete id="deleteBoard" parameterType="int">
        DELETE FROM board_category
        WHERE board_id = #{board_id}
    </delete>

</mapper>
