<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminBoardMapper">

    <!-- RESULT MAP -->
    <resultMap id="boardMap" type="com.itwillbs.domain.AdminBoardVO">
        <id property="board_id" column="board_id"/>
        <result property="board_name" column="board_name"/>
        <result property="board_desc" column="board_desc"/>
        <result property="is_active" column="is_active"/>
        <result property="created_at" column="created_at"/>
        <result property="board_order" column="board_order"/>

        <!-- 통계 -->
        <result property="post_count" column="post_count"/>
        <result property="post_count_month" column="post_count_month"/>
        <result property="post_count_visible" column="post_count_visible"/>
        <result property="report_count" column="report_count"/>

        <!-- 옵션 -->
        <result property="allow_comment" column="allow_comment"/>
        <result property="allow_image" column="allow_image"/>
        <result property="allow_file" column="allow_file"/>
        <result property="write_role" column="write_role"/>
        <result property="banned_words" column="banned_words"/>
        <result property="require_approval" column="require_approval"/>
    </resultMap>


    <!-- ========================================================= -->
    <!-- 1) 게시판 목록 조회                                        -->
    <!-- ========================================================= -->
    <select id="getBoardList" resultType="com.itwillbs.domain.AdminBoardVO">
        SELECT
            b.board_id,
            b.board_name,
            b.board_desc,
            b.is_active,
            b.created_at,
            b.board_order,

            /* 게시판별 전체 글 수 */
            (
                SELECT COUNT(*)
                FROM community_content c
                WHERE c.board_id = b.board_id
                   OR c.category_main_num = b.board_id
            ) AS post_count

        FROM board_category b
        ORDER BY b.board_order ASC
    </select>


    <!-- ========================================================= -->
    <!-- 2) 게시판 단일 조회                                        -->
    <!-- ========================================================= -->
    <select id="getBoard" parameterType="int" resultType="com.itwillbs.domain.AdminBoardVO">
        SELECT
            board_id,
            board_name,
            board_desc,
            is_active,
            created_at,
            board_order,
            allow_comment,
            allow_image,
            allow_file,
            write_role,
            banned_words,
            require_approval
        FROM board_category
        WHERE board_id = #{board_id}
    </select>


    <!-- ========================================================= -->
    <!-- 3) 게시판 상세 + 통계                                      -->
    <!-- ========================================================= -->
    <select id="getBoardDetail" parameterType="int" resultMap="boardMap">
        SELECT
            b.board_id,
            b.board_name,
            b.board_desc,
            b.is_active,
            b.created_at,
            b.board_order,
            b.allow_comment,
            b.allow_image,
            b.allow_file,
            b.write_role,
            b.banned_words,
            b.require_approval,

            /* 전체 글 수 */
            (
                SELECT COUNT(*)
                FROM community_content c
                WHERE c.board_id = b.board_id
                   OR c.category_main_num = b.board_id
            ) AS post_count,

            /* 이번달 글 수 */
            (
                SELECT COUNT(*)
                FROM community_content c
                WHERE (c.board_id = b.board_id
                    OR c.category_main_num = b.board_id)
                  AND c.created_at >= DATE_FORMAT(NOW(), '%Y-%m-01')
            ) AS post_count_month,

            /* 삭제되지 않은 글 수 */
            (
                SELECT COUNT(*)
                FROM community_content c
                WHERE (c.board_id = b.board_id
                    OR c.category_main_num = b.board_id)
                  AND c.is_deleted = 0
            ) AS post_count_visible,

            /* 신고된 글 수 */
            (
                SELECT COUNT(*)
                FROM report r
                JOIN community_content c ON r.post_id = c.post_id
                WHERE c.board_id = b.board_id
                   OR c.category_main_num = b.board_id
            ) AS report_count

        FROM board_category b
        WHERE b.board_id = #{board_id}
    </select>


    <!-- ========================================================= -->
    <!-- 4) 최근 게시글 5개                                         -->
    <!-- ========================================================= -->
    <select id="getRecentPosts" parameterType="int" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT
            post_id,
            title,
            user_num,
            created_at,
            is_deleted
        FROM community_content
        WHERE board_id = #{board_id}
           OR category_main_num = #{board_id}
        ORDER BY created_at DESC
        LIMIT 5
    </select>


    <!-- ========================================================= -->
    <!-- 5) 조회수 TOP5                                              -->
    <!-- ========================================================= -->
    <select id="getTopViewPosts" parameterType="int" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT
            post_id,
            title,
            views,
            0 AS report_count
        FROM community_content
        WHERE board_id = #{board_id}
           OR category_main_num = #{board_id}
        ORDER BY views DESC
        LIMIT 5
    </select>


    <!-- ========================================================= -->
    <!-- 6) 신고 많은 글 TOP5                                       -->
    <!-- ========================================================= -->
    <select id="getTopReportPosts" parameterType="int" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT
            c.post_id,
            c.title,
            c.views,
            COUNT(*) AS report_count
        FROM report r
        JOIN community_content c ON r.post_id = c.post_id
        WHERE c.board_id = #{board_id}
           OR c.category_main_num = #{board_id}
        GROUP BY c.post_id, c.title, c.views
        ORDER BY report_count DESC
        LIMIT 5
    </select>


    <!-- ========================================================= -->
    <!-- 7) 최근 7일 게시글 증가량                                  -->
    <!-- ========================================================= -->
    <select id="getWeeklyPostStats" parameterType="int" resultType="map">
        SELECT
            DATE(c.created_at) AS day,
            COUNT(*) AS count
        FROM community_content c
        WHERE c.board_id = #{board_id}
           OR c.category_main_num = #{board_id}
        AND c.created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
        GROUP BY DATE(c.created_at)
        ORDER BY day ASC
    </select>


    <!-- ========================================================= -->
    <!-- 8) 사용 중인 게시판 목록                                   -->
    <!-- ========================================================= -->
    <select id="getActiveBoardList" resultType="com.itwillbs.domain.AdminBoardVO">
        SELECT
            board_id,
            board_name,
            board_desc,
            is_active,
            board_order,
            created_at
        FROM board_category
        WHERE is_active = 1
        ORDER BY board_order ASC
    </select>
    
    <!-- ============================= -->
<!-- 게시판 숨기기 -->
<!-- ============================= -->
<update id="disableBoard">
    UPDATE board_category
    SET is_active = 0
    WHERE board_id = #{board_id}
</update>

<!-- ============================= -->
<!-- 게시판 표시 -->
<!-- ============================= -->
<update id="enableBoard">
    UPDATE board_category
    SET is_active = 1
    WHERE board_id = #{board_id}
</update>

<!-- ========================================================= -->
<!-- 9) 게시판 수정 (UPDATE)                                     -->
<!-- ========================================================= -->
<update id="updateBoard" parameterType="com.itwillbs.domain.AdminBoardVO">
    UPDATE board_category
    SET
        board_name       = #{board_name},
        board_desc       = #{board_desc},
        is_active        = #{is_active},
        allow_comment    = #{allow_comment},
        allow_image      = #{allow_image},
        allow_file       = #{allow_file},
        write_role       = #{write_role},
        banned_words     = #{banned_words},
        require_approval = #{require_approval}
    WHERE board_id = #{board_id}
</update>

    

</mapper>
