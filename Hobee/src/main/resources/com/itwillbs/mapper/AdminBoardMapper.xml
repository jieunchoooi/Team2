<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminBoardMapper">

    <!-- ================================================================= -->
    <!-- RESULT MAP -->
    <!-- ================================================================= -->
    <resultMap id="boardMap" type="com.itwillbs.domain.AdminBoardVO">
        <id property="board_id" column="board_id"/>
        <result property="board_name" column="board_name"/>
        <result property="board_desc" column="board_desc"/>
        <result property="is_active" column="is_active"/>
        <result property="created_at" column="created_at"/>
        <result property="board_order" column="board_order"/>
        <result property="post_count" column="post_count"/>
    </resultMap>


    <!-- ================================================================= -->
    <!-- 1) ê²Œì‹œíŒ ëª©ë¡ -->
    <!-- ================================================================= -->
    <select id="getBoardList" resultType="com.itwillbs.domain.AdminBoardVO">
    	SELECT
        	b.board_id,
        	b.parent_id,
        	b.board_name,
        	b.board_desc,
        	b.is_active,
        	b.created_at,
        	b.board_order,

        	(SELECT COUNT(*) 
         	FROM community_content c 
         	WHERE c.category_id = b.board_id) AS post_count

    	FROM board_category b
    	ORDER BY 
        	CASE WHEN parent_id IS NULL THEN board_order ELSE (SELECT board_order FROM board_category p WHERE p.board_id = b.parent_id) END,
        	parent_id,
        	board_order
	</select>

    <!-- ================================================================= -->
    <!-- 2) ê²Œì‹œíŒ ë‹¨ì¼ ì¡°íšŒ -->
    <!-- ================================================================= -->
    <select id="getBoard" resultMap="boardMap" parameterType="int">
        SELECT *
        FROM board_category
        WHERE board_id = #{board_id}
    </select>


    <!-- ================================================================= -->
    <!-- 3) ê²Œì‹œíŒ ìƒì„¸ + í†µê³„ -->
    <!-- ================================================================= -->
    <select id="getBoardDetail" parameterType="int"
            resultType="com.itwillbs.domain.AdminBoardVO">

        SELECT
            b.board_id,
            b.board_name,
            b.board_desc,
            b.is_active,
            b.created_at,

            (SELECT COUNT(*) 
             FROM community_content c
             WHERE c.category_id = b.board_id) AS post_count,

            (SELECT COUNT(*) 
             FROM community_content c
             WHERE c.category_id = b.board_id
               AND c.created_at >= DATE_FORMAT(NOW(), '%Y-%m-01')) 
             AS post_count_month,

            (SELECT COUNT(*)
             FROM community_content c
             WHERE c.category_id = b.board_id
               AND c.is_deleted = 0) AS post_count_visible,

            (SELECT COUNT(*)
             FROM report r
             JOIN community_content c ON r.post_id = c.post_id
             WHERE c.category_id = b.board_id) AS report_count

        FROM board_category b
        WHERE b.board_id = #{board_id}
    </select>


    <!-- ================================================================= -->
    <!-- ðŸ”¥  ìµœê·¼ ê²Œì‹œê¸€ 5ê°œ -->
    <!-- ================================================================= -->
    <select id="getRecentPosts" parameterType="int"
            resultType="com.itwillbs.domain.AdminPostVO">

        SELECT 
            post_id,
            title,
            user_num,
            created_at,
            is_deleted
        FROM community_content
        WHERE category_id = #{board_id}
        ORDER BY created_at DESC
        LIMIT 5
    </select>


    <!-- ================================================================= -->
    <!-- ðŸ”¥ 4) ì¸ê¸°ê¸€ TOP 5 (ì¡°íšŒìˆ˜ ìˆœ) -->
    <!-- ================================================================= -->
    <select id="getTopViewPosts" 
            parameterType="int"
            resultType="com.itwillbs.domain.AdminPostVO">

        SELECT 
            post_id,
            title,
            views,
            0 AS report_count   <!-- ê¸°ë³¸ê°’ -->
        FROM community_content
        WHERE category_id = #{board_id}
        ORDER BY views DESC
        LIMIT 5
    </select>


    <!-- ================================================================= -->
    <!-- ðŸ”¥ 5) ì‹ ê³  ë§Žì€ ê¸€ TOP 5 -->
    <!-- ================================================================= -->
    <select id="getTopReportPosts" 
            parameterType="int"
            resultType="com.itwillbs.domain.AdminPostVO">

        SELECT
            c.post_id,
            c.title,
            c.views,
            COUNT(*) AS report_count
        FROM report r
        JOIN community_content c ON r.post_id = c.post_id
        WHERE c.category_id = #{board_id}
        GROUP BY c.post_id, c.title, c.views
        ORDER BY report_count DESC
        LIMIT 5
    </select>


    <!-- ================================================================= -->
    <!-- ðŸ”¥ 6) ìµœê·¼ 7ì¼ ê²Œì‹œê¸€ ì¦ê°€ëŸ‰ (ê·¸ëž˜í”„ìš©) -->
    <!-- ================================================================= -->
    <select id="getWeeklyPostStats"
            parameterType="int"
            resultType="map">

        SELECT 
            DATE(created_at) AS day,
            COUNT(*) AS count
        FROM community_content
        WHERE category_id = #{board_id}
          AND created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
        GROUP BY DATE(created_at)
        ORDER BY day ASC
    </select>
    
    <select id="getParentCategories" resultType="com.itwillbs.domain.AdminBoardVO">
    	SELECT * 
    	FROM board_category
    	WHERE parent_id IS NULL
    	ORDER BY board_order ASC
	</select>
	
	<select id="getChildCategories" resultType="com.itwillbs.domain.AdminBoardVO" parameterType="int">
    	SELECT *
    	FROM board_category
    	WHERE parent_id = #{parent_id}
    	ORDER BY board_order ASC
	</select>
	
    
    <!-- ================================================================= -->
    <!-- 4) ê²Œì‹œíŒ ì¶”ê°€ -->
    <!-- ================================================================= -->
    <insert id="insertBoard" parameterType="com.itwillbs.domain.AdminBoardVO">
        INSERT INTO board_category (board_name, board_desc, is_active, created_at)
        VALUES (#{board_name}, #{board_desc}, #{is_active}, NOW())
    </insert>


    <!-- ================================================================= -->
    <!-- 5) ê²Œì‹œíŒ ìˆ˜ì • -->
    <!-- ================================================================= -->
    <update id="updateBoard" parameterType="com.itwillbs.domain.AdminBoardVO">
        UPDATE board_category
        SET 
            board_name = #{board_name},
            board_desc = #{board_desc},
            is_active = #{is_active}
            parent_id = #{parent_id}
        WHERE board_id = #{board_id}
    </update>


    <!-- ================================================================= -->
    <!-- 6) ì‚¬ìš©/ìˆ¨ê¹€ -->
    <!-- ================================================================= -->
    <update id="disableBoard" parameterType="int">
        UPDATE board_category
        SET is_active = 0
        WHERE board_id = #{board_id}
    </update>

    <update id="enableBoard" parameterType="int">
        UPDATE board_category
        SET is_active = 1
        WHERE board_id = #{board_id}
    </update>


    <!-- ================================================================= -->
    <!-- 7) ê²Œì‹œíŒ ìˆœì„œ ë³€ê²½ -->
    <!-- ================================================================= -->
    <update id="updateBoardOrder">
        UPDATE board_category
        SET board_order = #{board_order}
        WHERE board_id = #{board_id}
    </update>
    
    

</mapper>
