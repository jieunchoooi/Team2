<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.EnrollmentMapper">

  <!-- âœ… ìˆ˜ê°• ë“±ë¡ -->
  <insert id="insertEnrollment" parameterType="com.itwillbs.domain.EnrollmentVO" useGeneratedKeys="true" keyProperty="enrollment_id">
    INSERT INTO enrollment (
        user_num,
        lecture_num,
        payment_id,
        enrolled_at
    )
    VALUES (
        #{user_num},
        #{lecture_num},
        #{payment_id},
        NOW()
    )
  </insert>

 
  <!-- ============================================
     ðŸ”¹ íŠ¹ì • íšŒì›ì˜ ìˆ˜ê°• ë‚´ì—­ ì¡°íšŒ (ë‚´ ê°•ì˜ì‹¤)
     ============================================ -->

<select id="getEnrollmentsByUser"
        parameterType="int"
        resultType="com.itwillbs.domain.EnrollmentViewVO">

    SELECT
        e.enrollment_id,
        e.user_num,
        e.lecture_num,
        e.payment_id,
        e.enrolled_at,

        l.lecture_title,
        l.lecture_author,
        l.lecture_price,
        l.category_detail,
        l.lecture_img,
        l.lecture_detail        <!-- â­ ì¶”ê°€ëœ í•„ë“œ -->

    FROM enrollment e
    LEFT JOIN lecture l ON e.lecture_num = l.lecture_num

    WHERE e.user_num = #{user_num}
    ORDER BY e.enrolled_at DESC
</select>

  <!-- âœ… íŠ¹ì • ê°•ì˜ì˜ ìˆ˜ê°•ìž ëª©ë¡ (ê´€ë¦¬ìžìš©) -->
  <select id="getEnrollmentsByLecture" parameterType="int" resultType="com.itwillbs.domain.EnrollmentVO">
    SELECT 
        e.enrollment_id,
        e.user_num,
        e.lecture_num,
        e.payment_id,
        e.enrolled_at,
        u.user_name,
        u.user_email,
        p.status AS payment_status
    FROM enrollment e
    LEFT JOIN user u ON e.user_num = u.user_num
    LEFT JOIN payment p ON e.payment_id = p.payment_id
    WHERE e.lecture_num = #{lecture_num}
    ORDER BY e.enrolled_at DESC
  </select>

  <!-- âœ… ê²°ì œë³„ ìˆ˜ê°• ëª©ë¡ (ê²°ì œ ìƒì„¸ìš©) -->
  <select id="getEnrollmentsByPayment" parameterType="int" resultType="com.itwillbs.domain.EnrollmentVO">
    SELECT 
        e.enrollment_id,
        e.user_num,
        e.lecture_num,
        e.payment_id,
        e.enrolled_at,
        l.title AS lecture_title,
        l.category,
        l.thumbnail AS lecture_thumbnail,
        l.teacher_name
    FROM enrollment e
    LEFT JOIN lecture l ON e.lecture_num = l.lecture_num
    WHERE e.payment_id = #{payment_id}
    ORDER BY e.enrolled_at DESC
  </select>

  <!-- âœ… ì¤‘ë³µ ë“±ë¡ ë°©ì§€ (íšŒì› + ê°•ì˜ ê¸°ì¤€) -->
  <select id="checkEnrollmentExists" parameterType="com.itwillbs.domain.EnrollmentVO" resultType="int">
    SELECT COUNT(*) 
    FROM enrollment
    WHERE user_num = #{user_num}
      AND lecture_num = #{lecture_num}
  </select>
  
    <!-- í™˜ë¶ˆ ì‹œ enrollment ìƒíƒœ ë³€ê²½ -->
    <update id="cancelEnrollmentByPaymentId">
        UPDATE enrollment
        SET status = 'cancelled'
        WHERE payment_id = #{payment_id}
    </update>

</mapper>
