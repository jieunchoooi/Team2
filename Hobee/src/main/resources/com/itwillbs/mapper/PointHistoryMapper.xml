<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.PointHistoryMapper">

  <!-- ðŸ”¹ í¬ì¸íŠ¸ ë‚´ì—­ ê¸°ë¡ -->
  <insert id="insertPointHistory" parameterType="com.itwillbs.domain.PointHistoryVO">
    INSERT INTO point_history (
        user_num,
        payment_id,
        point_change,
        type,
        description,
        created_at
    )
    VALUES (
        #{user_num},
        #{payment_id},
        #{point_change},
        #{type},
        #{description},
        NOW()
    )
  </insert>

 
  
  <!-- ðŸ”¹ í¬ì¸íŠ¸ ì°¨ê° -->
<update id="deductPoints" parameterType="com.itwillbs.domain.PointHistoryVO">
  UPDATE user
  SET points = points + #{point_change}
  WHERE user_num = #{user_num};
</update>

<!-- ðŸ”¹ í¬ì¸íŠ¸ ì ë¦½ -->
<update id="addPoints" parameterType="com.itwillbs.domain.PointHistoryVO">
  UPDATE user
  SET points = points + #{point_change}
  WHERE user_num = #{user_num};
</update>

  <!-- ðŸ”¹ íŠ¹ì • íšŒì›ì˜ ì „ì²´ í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ -->
  <select id="getPointHistoryByUser" parameterType="int" resultType="com.itwillbs.domain.PointHistoryVO">
    SELECT 
        ph.point_id,
        ph.user_num,
        ph.payment_id,
        ph.point_change,
        ph.type,
        ph.description,
        ph.created_at,
        p.merchant_uid,
        p.amount AS payment_amount
    FROM point_history ph
    LEFT JOIN payment p ON ph.payment_id = p.payment_id
    WHERE ph.user_num = #{user_num}
    ORDER BY ph.created_at DESC
  </select>

  <!-- ðŸ”¹ íŠ¹ì • íšŒì›ì˜ í¬ì¸íŠ¸ ì´í•© ì¡°íšŒ (user í…Œì´ë¸” ê¸°ì¤€) -->
  <select id="getUserTotalPoints" parameterType="int" resultType="int">
    SELECT user_points
    FROM user
    WHERE user_num = #{user_num}
  </select>

  <!-- ðŸ”¹ íŠ¹ì • ê²°ì œì˜ í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ -->
  <select id="getPointHistoryByPayment" parameterType="int" resultType="com.itwillbs.domain.PointHistoryVO">
    SELECT 
        point_id,
        user_num,
        payment_id,
        point_change,
        type,
        description,
        created_at
    FROM point_history
    WHERE payment_id = #{payment_id}
    ORDER BY created_at DESC
  </select>
  
  
  <!-- âœ… íŠ¸ëžœìž­ì…˜ í…ŒìŠ¤íŠ¸ìš© ìž„ì‹œ INSERT -->
  <insert id="insertPointHistoryForTest">
    INSERT INTO point_history (user_num, used_points, saved_points, type, created_at)
    VALUES (1, 0, 100, 'TEST', NOW())
  </insert>

</mapper>
