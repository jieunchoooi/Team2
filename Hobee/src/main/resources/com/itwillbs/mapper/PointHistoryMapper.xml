<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.PointHistoryMapper">

  <!-- ðŸ”¹ í¬ì¸íŠ¸ ë‚´ì—­ ê¸°ë¡ -->
  <insert id="insertPointHistory"
        parameterType="com.itwillbs.domain.PaymentDetailVO"
        useGeneratedKeys="true"
        keyProperty="detail_id">
    INSERT INTO point_history (
        user_num,
        detail_id,
        point_change,
        type,
        description,
        created_at
    )
    VALUES (
        #{user_num},
        #{detail_id},
        #{point_change},
        #{type},
        #{description},
        NOW()
    )
  </insert>

  <!-- ðŸ”¹ í¬ì¸íŠ¸ ì°¨ê° -->
  <update id="deductPoints" parameterType="com.itwillbs.domain.PointHistoryVO">
    UPDATE user
    SET points = points + #{point_change}
    WHERE user_num = #{user_num};
  </update>

  <!-- ðŸ”¹ í¬ì¸íŠ¸ ì ë¦½ -->
  <update id="addPoints" parameterType="com.itwillbs.domain.PointHistoryVO">
    UPDATE user
    SET points = points + #{point_change}
    WHERE user_num = #{user_num};
  </update>

  <!-- ðŸ”¹ íŠ¹ì • íšŒì›ì˜ í¬ì¸íŠ¸ ì´í•© ì¡°íšŒ (user í…Œì´ë¸” ê¸°ì¤€) -->
  <select id="getUserTotalPoints" parameterType="int" resultType="int">
    SELECT points
    FROM user
    WHERE user_num = #{user_num}
  </select>


  <!-- ðŸ”¹ íŠ¹ì • ê²°ì œì˜ í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ (payment_id ê¸°ì¤€ â†’ detail_id ê¸°ì¤€ìœ¼ë¡œ ë³€ê²½ë¨) -->
  <select id="getPointHistoryByPayment" parameterType="int" resultType="com.itwillbs.domain.PointHistoryVO">
    SELECT 
        ph.history_id,
        ph.user_num,
        ph.detail_id,
        ph.point_change,
        ph.type,
        ph.description,
        ph.created_at
    FROM point_history ph
    JOIN payment_detail pd
        ON ph.detail_id = pd.detail_id
    WHERE pd.payment_id = #{payment_id}
    ORDER BY ph.created_at DESC
  </select>


  <!-- ðŸ”¹ í…ŒìŠ¤íŠ¸ìš© (ë¬´ì˜ë¯¸í•œ ì»¬ëŸ¼ ì œê±° í›„ ì •ìƒí™”) -->
  <insert id="insertPointHistoryForTest">
    INSERT INTO point_history (user_num, detail_id, point_change, type, description, created_at)
    VALUES (1, 1, 100, 'TEST', 'í…ŒìŠ¤íŠ¸', NOW())
  </insert>


  <!-- ===========================================
         1) íšŒì›ë³„ í¬ì¸íŠ¸ ë‚´ì—­ ì¡°íšŒ (ê°•ì˜ ë‹¨ìœ„ FULL JOIN)
         =========================================== -->
  <select id="getPointHistoryByUser" resultType="com.itwillbs.domain.PointHistoryVO">
      SELECT
          /* ===== point_history ===== */
          ph.history_id,
          ph.user_num,
          ph.detail_id,
          ph.point_change,
          ph.type,
          ph.description,
          ph.created_at,

          /* ===== payment_detail ===== */
          pd.payment_id,
          pd.lecture_num,
          pd.original_price,
          pd.sale_price,
          pd.used_points,
          pd.saved_points,
          pd.status AS detail_status,

          /* ===== payment ===== */
          p.merchant_uid,
          p.amount AS payment_amount,
          p.created_at AS payment_created_at,

          /* ===== lecture ===== */
          l.lecture_title,
          l.lecture_author,
          l.lecture_img,
          l.lecture_price

      FROM point_history ph

      /* detail_id ê¸°ì¤€ JOIN */
      LEFT JOIN payment_detail pd
        ON ph.detail_id = pd.detail_id

      /* payment JOIN */
      LEFT JOIN payment p
        ON pd.payment_id = p.payment_id

      /* lecture JOIN */
      LEFT JOIN lecture l
        ON pd.lecture_num = l.lecture_num

      WHERE ph.user_num = #{user_num}
      ORDER BY ph.created_at DESC
  </select>

</mapper>
