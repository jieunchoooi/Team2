<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.PointHistoryMapper">

  <!-- üîπ Ìè¨Ïù∏Ìä∏ ÎÇ¥Ïó≠ Í∏∞Î°ù -->
  <insert id="insertPointHistory" parameterType="com.itwillbs.domain.PointHistoryVO">
    INSERT INTO point_history (
        user_num,
        payment_id,
        point_change,
        type,
        description,
        created_at
    )
    VALUES (
        #{user_num},
        #{payment_id},
        #{point_change},
        #{type},
        #{description},
        NOW()
    )
  </insert>

 
  
  <!-- üîπ Ìè¨Ïù∏Ìä∏ Ï∞®Í∞ê -->
<update id="deductPoints" parameterType="com.itwillbs.domain.PointHistoryVO">
  UPDATE user
  SET points = points + #{point_change}
  WHERE user_num = #{user_num};
</update>

<!-- üîπ Ìè¨Ïù∏Ìä∏ Ï†ÅÎ¶Ω -->
<update id="addPoints" parameterType="com.itwillbs.domain.PointHistoryVO">
  UPDATE user
  SET points = points + #{point_change}
  WHERE user_num = #{user_num};
</update>


  <!-- üîπ ÌäπÏ†ï ÌöåÏõêÏùò Ìè¨Ïù∏Ìä∏ Ï¥ùÌï© Ï°∞Ìöå (user ÌÖåÏù¥Î∏î Í∏∞Ï§Ä) -->
  <select id="getUserTotalPoints" parameterType="int" resultType="int">
    SELECT user_points
    FROM user
    WHERE user_num = #{user_num}
  </select>

  <!-- üîπ ÌäπÏ†ï Í≤∞Ï†úÏùò Ìè¨Ïù∏Ìä∏ ÎÇ¥Ïó≠ Ï°∞Ìöå -->
  <select id="getPointHistoryByPayment" parameterType="int" resultType="com.itwillbs.domain.PointHistoryVO">
    SELECT 
        point_id,
        user_num,
        payment_id,
        point_change,
        type,
        description,
        created_at
    FROM point_history
    WHERE payment_id = #{payment_id}
    ORDER BY created_at DESC
  </select>
  
  
  <!-- ‚úÖ Ìä∏ÎûúÏû≠ÏÖò ÌÖåÏä§Ìä∏Ïö© ÏûÑÏãú INSERT -->
  <insert id="insertPointHistoryForTest">
    INSERT INTO point_history (user_num, used_points, saved_points, type, created_at)
    VALUES (1, 0, 100, 'TEST', NOW())
  </insert>
  
  
 <!-- ===========================================
         1) ÌöåÏõêÎ≥Ñ Ìè¨Ïù∏Ìä∏ ÎÇ¥Ïó≠ Ï°∞Ìöå (Í∞ïÏùò Îã®ÏúÑ FULL JOIN)
         =========================================== -->
    <select id="getPointHistoryByUser" resultType="com.itwillbs.domain.PointHistoryVO">
        SELECT
            /* ===================== point_history ===================== */
            ph.point_history_id,
            ph.user_num,
            ph.payment_id,
            ph.point_change,
            ph.type,
            ph.description,
            ph.created_at,

            /* ========================= payment ======================== */
            p.merchant_uid,
            p.amount AS payment_amount,
            p.created_at AS payment_created_at,

            /* ====================== payment_detail ==================== */
            pd.detail_id,
            pd.lecture_num,
            pd.original_price,
            pd.sale_price,
            pd.used_points,
            pd.saved_points,
            pd.status AS detail_status,

            /* ========================= lecture ======================== */
            l.lecture_title,
            l.lecture_author,
            l.lecture_img,
            l.lecture_price

        FROM point_history ph

        /* Í≤∞Ï†ú Ï†ïÎ≥¥ JOIN */
        LEFT JOIN payment p
            ON ph.payment_id = p.payment_id

        /* ÏÉÅÏÑ∏ Ï†ïÎ≥¥ JOIN (Í≤∞Ï†úÍ±¥ ÏïàÏóê Í∞ïÏùòÎ≥Ñ Ìè¨Ïù∏Ìä∏ ÎÇòÎà†ÏßÑ Î∂ÄÎ∂Ñ) */
        LEFT JOIN payment_detail pd
            ON ph.payment_id = pd.payment_id

        /* Í∞ïÏùò Ï†ïÎ≥¥ JOIN */
        LEFT JOIN lecture l
            ON pd.lecture_num = l.lecture_num

        WHERE ph.user_num = #{user_num}
        ORDER BY ph.created_at DESC
    </select>
  

</mapper>
