<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.CommunityMapper">

    <!-- ======================================================
         0. 단일 카운트
    ====================================================== -->
    <select id="getCommunityCount" resultType="int"><![CDATA[
        SELECT COUNT(*)
        FROM community_content
        WHERE category_main_num = #{category_main_num}
          AND is_deleted = 0
    ]]></select>


    <!-- ======================================================
         1. 핫토픽 리스트 (24시간 기준)
         summary = 120자
    ====================================================== -->
    <select id="getHotTopicList" resultType="com.itwillbs.domain.CommunityContentVO"><![CDATA[
        SELECT
            c.post_id,
            c.title,

            SUBSTRING(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(
                        REGEXP_REPLACE(c.content, '<[^>]*>', ''),
                        '[<>]', ''
                    ),
                    '&[^;]+;', ''
                ), 1, 120
            ) AS summary,

            COUNT(DISTINCT l.like_id) AS like_count,
            COUNT(DISTINCT cc.comment_id) AS comment_count,

            c.views,
            c.created_at,

            u.user_name,
            u.user_file,

            cm.category_main_name,
            bc.board_name,
            bc.board_desc,

            (
                (COUNT(DISTINCT l.like_id) * 4)
              + (COUNT(DISTINCT cc.comment_id) * 3)
              + (c.views * 0.2)
            )
            /
            POW(TIMESTAMPDIFF(HOUR, c.created_at, NOW()) + 1, 1.3)
            AS trendingScore

        FROM community_content c
        JOIN user u ON c.user_num = u.user_num
        LEFT JOIN category_main cm ON c.category_main_num = cm.category_main_num
        LEFT JOIN board_category bc ON c.board_id = bc.board_id
        LEFT JOIN community_content_like l ON c.post_id = l.post_id
        LEFT JOIN community_comment cc ON c.post_id = cc.post_id

        WHERE c.is_deleted = 0
          AND c.created_at >= NOW() - INTERVAL 24 HOUR

        GROUP BY c.post_id
        ORDER BY trendingScore DESC
        LIMIT 10
    ]]></select>



    <!-- ======================================================
         2. 인기글 리스트 (좋아요 기준)
    ====================================================== -->
    <select id="getPopularPosts" resultType="com.itwillbs.domain.CommunityContentVO"><![CDATA[
        SELECT
            c.post_id,
            c.title,
            c.views,
            c.created_at,

            u.user_name,
            u.user_file,

            cm.category_main_name,
            bc.board_name,
            bc.board_desc,

            SUBSTRING(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(
                        REGEXP_REPLACE(c.content, '<[^>]*>', ''),
                        '[<>]', ''
                    ),
                    '&[^;]+;', ''
                ), 1, 60
            ) AS summary,

            (SELECT COUNT(*)
             FROM community_content_like l
             WHERE l.post_id = c.post_id AND l.is_like = 1)
             AS like_count

        FROM community_content c
        JOIN user u ON c.user_num = u.user_num
        LEFT JOIN category_main cm ON c.category_main_num = cm.category_main_num
        LEFT JOIN board_category bc ON c.board_id = bc.board_id

        WHERE c.is_deleted = 0
        ORDER BY like_count DESC, c.views DESC
        LIMIT 5
    ]]></select>



    <!-- ======================================================
         3. 좌측 말머리(board_category) 리스트
    ====================================================== -->
    <select id="getCategoryList" resultType="com.itwillbs.domain.CommunityCategoryVO">
        SELECT
            board_id,
            board_name,
            board_desc
        FROM board_category
    </select>



    <!-- ======================================================
         4. 메인 카테고리(category_main) 리스트
    ====================================================== -->
    <select id="getCategoryMainList" resultType="com.itwillbs.domain.CommunityContentVO">
        SELECT
            category_main_num,
            category_main_name
        FROM category_main
    </select>

<!-- ======================================================
         4-2. 메인 카테고리(category_main) 리스트
    ====================================================== -->
    <select id="getMainCategoryList" resultType="com.itwillbs.domain.Category_mainVO">
        SELECT
            category_main_num,
            category_main_name,
            category_main_order
        FROM category_main
    </select>

    <!-- ======================================================
         5. 게시글 목록 조회 (summary = 120자)
    ====================================================== -->
    <select id="getCommunityList" resultType="com.itwillbs.domain.CommunityContentVO">

<![CDATA[
        SELECT
            c.post_id,
            c.title,
            c.content,
            c.user_num,
            c.board_id,
            c.category_main_num,
            c.lecture_num,
            c.views,
            c.is_visible,
            c.is_deleted,
            c.created_at,
            c.updated_at,

            u.user_name,
            u.user_file,

            cm.category_main_name,
            bc.board_name,
            bc.board_desc,

            SUBSTRING(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(
                        REGEXP_REPLACE(c.content, '<[^>]*>', ''),
                        '[<>]', ''
                    ),
                    '&[^;]+;', ''
                ), 1, 120
            ) AS summary,

            (SELECT COUNT(*)
             FROM community_comment cc2
             WHERE cc2.post_id = c.post_id AND cc2.is_deleted = 0)
             AS comment_count,

            (SELECT COUNT(*)
             FROM community_content_like l1
             WHERE l1.post_id = c.post_id AND l1.is_like = 1)
             AS like_count

        FROM community_content c
        JOIN user u ON c.user_num = u.user_num
        LEFT JOIN category_main cm ON c.category_main_num = cm.category_main_num
        LEFT JOIN board_category bc ON c.board_id = bc.board_id
]]>

        <where>
            <if test="board_id != null">
                AND c.board_id = #{board_id}
            </if>

            <if test="category_main_num != null">
                AND c.category_main_num = #{category_main_num}
            </if>

            <choose>
                <when test="period == 'today'">
                    AND DATE(c.created_at) = CURDATE()
                </when>
                <when test="period == 'week'">
                    AND c.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
                </when>
                <when test="period == 'month'">
                    AND c.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
                </when>
            </choose>

            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND c.title LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <when test="searchType == 'titleContent'">
                        AND (c.title LIKE CONCAT('%', #{keyword}, '%')
                         OR c.content LIKE CONCAT('%', #{keyword}, '%'))
                    </when>
                    <when test="searchType == 'writer'">
                        AND u.user_name LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <when test="searchType == 'comment'">
                        AND EXISTS (
                            SELECT 1 FROM community_comment co
                            WHERE co.post_id = c.post_id
                              AND co.is_deleted = 0
                              AND co.content LIKE CONCAT('%', #{keyword}, '%')
                        )
                    </when>
                </choose>
            </if>

            AND c.is_deleted = 0
        </where>

        <choose>
            <when test="sort == 'views'">ORDER BY c.views DESC</when>
            <when test="sort == 'likes'">ORDER BY like_count DESC</when>
            <when test="sort == 'comments'">ORDER BY comment_count DESC</when>
            <otherwise>ORDER BY c.created_at DESC</otherwise>
        </choose>

        LIMIT #{amount} OFFSET #{offset}

    </select>



    <!-- ======================================================
         6. 총 게시글 수 (페이징용)
    ====================================================== -->
    <select id="getTotalCount" resultType="int">

<![CDATA[
        SELECT COUNT(DISTINCT c.post_id)
        FROM community_content c
        JOIN user u ON c.user_num = u.user_num
        LEFT JOIN board_category bc ON c.board_id = bc.board_id
        LEFT JOIN community_comment co ON co.post_id = c.post_id
]]>

        <where>
            <if test="board_id != null">
                AND c.board_id = #{board_id}
            </if>

            <if test="category_main_num != null">
                AND c.category_main_num = #{category_main_num}
            </if>

            <choose>
                <when test="period == 'today'">
                    AND DATE(c.created_at) = CURDATE()
                </when>
                <when test="period == 'week'">
                    AND c.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
                </when>
                <when test="period == 'month'">
                    AND c.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
                </when>
            </choose>

            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND c.title LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <when test="searchType == 'titleContent'">
                        AND (c.title LIKE CONCAT('%', #{keyword}, '%')
                         OR c.content LIKE CONCAT('%', #{keyword}, '%'))
                    </when>
                    <when test="searchType == 'writer'">
                        AND u.user_name LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                    <when test="searchType == 'comment'">
                        AND co.content LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                </choose>
            </if>

            AND c.is_deleted = 0
        </where>

    </select>



    <!-- ======================================================
         7. 게시글 상세 조회 (+ 좋아요 여부)
    ====================================================== -->
    <select id="getPostDetailWithLike"
            resultType="com.itwillbs.domain.CommunityContentVO"><![CDATA[
        SELECT
            c.*,
            u.user_name,
            u.user_file,

            bc.board_name,
            bc.board_desc,
            cm.category_main_name,

            (SELECT is_like
             FROM community_content_like l
             WHERE l.post_id = c.post_id
               AND l.user_num = #{user_num}
             LIMIT 1)
             AS user_reaction,

            (SELECT COUNT(*) FROM community_content_like l1
             WHERE l1.post_id = c.post_id AND l1.is_like = 1)
             AS like_count,

            (SELECT COUNT(*) FROM community_comment co
             WHERE co.post_id = c.post_id AND co.is_deleted = 0)
             AS comment_count

        FROM community_content c
        JOIN user u ON c.user_num = u.user_num
        LEFT JOIN board_category bc ON c.board_id = bc.board_id
        LEFT JOIN category_main cm ON c.category_main_num = cm.category_main_num

        WHERE c.post_id = #{post_id}
          AND c.is_deleted = 0
    ]]></select>



    <!-- ======================================================
         8. 댓글 조회 (좋아요/싫어요 포함)
    ====================================================== -->
    <select id="getCommentsByPostId"
            resultType="com.itwillbs.domain.CommunityCommentVO">

        SELECT
            c.comment_id,
            c.post_id,
            c.user_num,
            c.parent_id,
            c.content,
            c.is_deleted,
            c.created_at,
            c.updated_at,

            u.user_name,
            u.user_file,

            COALESCE(SUM(CASE WHEN cl.is_like = 1 THEN 1 END), 0) AS like_count,
            COALESCE(SUM(CASE WHEN cl.is_like = 0 THEN 1 END), 0) AS dislike_count,

            (
                SELECT cl2.is_like
                FROM community_comment_like cl2
                WHERE cl2.comment_id = c.comment_id
                AND cl2.user_num = #{user_num}
                LIMIT 1
            ) AS my_like_status

        FROM community_comment c
        JOIN user u ON c.user_num = u.user_num
        LEFT JOIN community_comment_like cl ON c.comment_id = cl.comment_id

        WHERE c.post_id = #{post_id}
          AND c.is_deleted = 0

        GROUP BY
            c.comment_id,
            c.post_id,
            c.user_num,
            c.parent_id,
            c.content,
            c.is_deleted,
            c.created_at,
            c.updated_at,
            u.user_name,
            u.user_file

        ORDER BY c.parent_id ASC, c.comment_id ASC
    </select>



    <!-- ======================================================
         9. 이전/다음 글 조회 (현재 포함, 7개)
    ====================================================== -->
    <!-- ======================================================
     9. 이전/다음 글 조회 (현재 포함, 7개)
====================================================== -->
<select id="getPrevNextPosts" resultType="com.itwillbs.domain.CommunityContentVO"><![CDATA[
    WITH filtered AS (

        SELECT
            c.post_id,
            c.title,
            c.content,
            c.user_num,
            u.user_name,
            c.board_id,
            c.category_main_num,
            c.created_at,
            c.views,
            c.is_deleted,

            (SELECT COUNT(*) FROM community_content_like l
             WHERE l.post_id = c.post_id AND l.is_like = 1)
             AS like_count,

            (SELECT COUNT(*) FROM community_comment cm2
             WHERE cm2.post_id = c.post_id AND cm2.is_deleted = 0)
             AS comment_count,

            CAST(ROW_NUMBER() OVER (
                ORDER BY
]]>
    <choose>
        <when test="cri.sort == 'views'"><![CDATA[
                c.views DESC
        ]]></when>

        <when test="cri.sort == 'likes'"><![CDATA[
                (SELECT COUNT(*) FROM community_content_like l2
                 WHERE l2.post_id = c.post_id AND l2.is_like = 1) DESC
        ]]></when>

        <when test="cri.sort == 'comments'"><![CDATA[
                (SELECT COUNT(*) FROM community_comment cm3
                 WHERE cm3.post_id = c.post_id AND cm3.is_deleted = 0) DESC
        ]]></when>

        <otherwise><![CDATA[
                c.created_at DESC
        ]]></otherwise>
    </choose>
<![CDATA[
            ) AS SIGNED) AS rn

        FROM community_content c
        JOIN user u ON c.user_num = u.user_num

        WHERE c.is_deleted = 0
]]>

    <if test="cri.board_id != null">
        AND c.board_id = #{cri.board_id}
    </if>

    <if test="cri.category_main_num != null">
        AND c.category_main_num = #{cri.category_main_num}
    </if>

    <choose>
        <when test="cri.period == 'today'">
            AND DATE(c.created_at) = CURDATE()
        </when>
        <when test="cri.period == 'week'">
            AND c.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
        </when>
        <when test="cri.period == 'month'">
            AND c.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
        </when>
    </choose>

    <if test="cri.keyword != null and cri.keyword != ''">
        <choose>
            <when test="cri.searchType == 'title'">
                AND c.title LIKE CONCAT('%', #{cri.keyword}, '%')
            </when>
            <when test="cri.searchType == 'titleContent'">
                AND (c.title LIKE CONCAT('%', #{cri.keyword}, '%')
                OR c.content LIKE CONCAT('%', #{cri.keyword}, '%'))
            </when>
            <when test="cri.searchType == 'writer'">
                AND u.user_name LIKE CONCAT('%', #{cri.keyword}, '%')
            </when>
            <when test="cri.searchType == 'comment'">
                AND EXISTS (
                    SELECT 1 FROM community_comment co
                    WHERE co.post_id = c.post_id
                    AND co.is_deleted = 0
                    AND co.content LIKE CONCAT('%', #{cri.keyword}, '%')
                )
            </when>
        </choose>
    </if>

<![CDATA[
    ),

    current_post AS (
        SELECT rn
        FROM filtered
        WHERE post_id = #{post_id}
    )

    SELECT f.*
    FROM filtered f
    JOIN current_post cp
      ON f.rn BETWEEN GREATEST(cp.rn - 3, 1)
                 AND cp.rn + 3

    ORDER BY f.rn ASC
]]></select>




    <!-- ======================================================
         10. 조회수 증가
    ====================================================== -->
    <update id="updateViewCount">
        UPDATE community_content
        SET views = views + 1
        WHERE post_id = #{post_id}
    </update>



    <!-- ======================================================
         11. 게시글 좋아요
    ====================================================== -->
    <insert id="upsertPostLike">
        INSERT INTO community_content_like (post_id, user_num, is_like)
        VALUES (#{post_id}, #{user_num}, 1)
        ON DUPLICATE KEY UPDATE is_like = 1
    </insert>

    <delete id="deletePostLike">
        DELETE FROM community_content_like
        WHERE post_id = #{post_id}
          AND user_num = #{user_num}
    </delete>



    <!-- ======================================================
         12. 댓글 좋아요
    ====================================================== -->
    <insert id="upsertCommentLike">
        INSERT INTO community_comment_like (comment_id, user_num, is_like)
        VALUES (#{comment_id}, #{user_num}, 1)
        ON DUPLICATE KEY UPDATE is_like = 1
    </insert>

    <delete id="deleteCommentLike">
        DELETE FROM community_comment_like
        WHERE comment_id = #{comment_id}
          AND user_num = #{user_num}
    </delete>



    <!-- ======================================================
         13. 게시글 작성
    ====================================================== -->
    <insert id="insertPost"
            parameterType="com.itwillbs.domain.CommunityContentVO"
            useGeneratedKeys="true"
            keyProperty="post_id">
        INSERT INTO community_content
        (title, content, user_num, board_id, category_main_num, created_at, updated_at, is_visible, is_deleted)
        VALUES
        (#{title}, #{content}, #{user_num}, #{board_id}, #{category_main_num},
         NOW(), NOW(), 1, 0)
    </insert>



    <!-- ======================================================
         14. 게시글 단일 조회 (수정용)
    ====================================================== -->
    <select id="getPostById" resultType="com.itwillbs.domain.CommunityContentVO">
        SELECT
            post_id,
            title,
            content,
            user_num,
            board_id,
            category_main_num,
            views,
            created_at,
            updated_at,
            is_deleted
        FROM community_content
        WHERE post_id = #{post_id}
          AND is_deleted = 0
    </select>



    <!-- ======================================================
         15. 게시글 수정
    ====================================================== -->
    <update id="updatePost" parameterType="com.itwillbs.domain.CommunityContentVO">
        UPDATE community_content
        SET title = #{title},
            content = #{content},
            board_id = #{board_id},
            category_main_num = #{category_main_num},
            updated_at = NOW()
        WHERE post_id = #{post_id}
          AND is_deleted = 0
    </update>



    <!-- ======================================================
         16. 게시글 삭제 (Soft delete)
    ====================================================== -->
    <update id="deletePost" parameterType="int">
        UPDATE community_content
        SET is_deleted = 1
        WHERE post_id = #{post_id}
    </update>



    <!-- ======================================================
         17. 댓글 INSERT
    ====================================================== -->
    <insert id="insertComment"
            parameterType="com.itwillbs.domain.CommunityCommentVO">
        INSERT INTO community_comment
        (post_id, user_num, parent_id, content, created_at, updated_at, is_deleted, report_count)
        VALUES
        (#{post_id}, #{user_num}, #{parent_id}, #{content},
         NOW(), NOW(), 0, 0)
    </insert>



    <!-- ======================================================
         18. 댓글 UPDATE
    ====================================================== -->
    <update id="updateComment">
        UPDATE community_comment
        SET content = #{content},
            updated_at = NOW()
        WHERE comment_id = #{comment_id}
          AND user_num = #{user_num}
          AND is_deleted = 0
    </update>



    <!-- ======================================================
         19. 댓글 DELETE
    ====================================================== -->
    <update id="deleteComment">
        UPDATE community_comment
        SET is_deleted = 1
        WHERE comment_id = #{comment_id}
          AND user_num = #{user_num}
          AND is_deleted = 0
    </update>



    <!-- ======================================================
         20. 신고 체크
    ====================================================== -->
    <select id="checkAlreadyReported" resultType="int">
        SELECT COUNT(*)
        FROM community_report
        WHERE reporter_id = #{user_num}
          AND post_id = #{post_id}
    </select>

    <select id="checkAlreadyReportedComment" resultType="int">
        SELECT COUNT(*)
        FROM community_report
        WHERE reporter_id = #{user_num}
          AND comment_id = #{comment_id}
    </select>



    <!-- ======================================================
         21. 신고 INSERT
    ====================================================== -->
    <insert id="insertReport"
            parameterType="com.itwillbs.domain.CommunityReportVO">
        INSERT INTO community_report
        (reporter_id, post_id, comment_id, reason, created_at, is_done)
        VALUES
        (#{reporter_id}, #{post_id}, #{comment_id}, #{reason}, NOW(), 0)
    </insert>

</mapper>
