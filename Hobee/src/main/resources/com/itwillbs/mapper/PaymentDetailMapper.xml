<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.PaymentDetailMapper">


<insert id="insert" parameterType="com.itwillbs.domain.PaymentDetailVO"
        useGeneratedKeys="true" keyProperty="detail_id">
    INSERT INTO payment_detail
    (payment_id, lecture_num, original_price, sale_price, used_points, saved_points, status)
    VALUES
    (#{payment_id}, #{lecture_num}, #{original_price}, #{sale_price}, #{used_points}, #{saved_points}, #{status});
</insert>
<select id="getDetailsByPaymentId" resultType="com.itwillbs.domain.PaymentDetailVO">
    SELECT *
    FROM payment_detail
    WHERE payment_id = #{paymentId}
</select>

   <!-- ðŸ”¹ detail_idë¡œ ë””í…Œì¼ ì¡°íšŒ -->
    <select id="getDetailById" parameterType="int" resultType="com.itwillbs.domain.PaymentDetailVO">
        SELECT *
        FROM payment_detail
        WHERE detail_id = #{detail_id}
    </select>


    <!-- ðŸ”¹ ë¶€ë¶„ í™˜ë¶ˆ ì‹œ í•´ë‹¹ detail ìƒíƒœ ë³€ê²½ -->
    <update id="updateDetailStatusRefund" parameterType="int">
        UPDATE payment_detail
        SET status = 'refunded'
        WHERE detail_id = #{detail_id}
    </update>


    <!-- ðŸ”¹ ë‚¨ì•„ìžˆëŠ” paid detail ê°œìˆ˜(ë¶€ë¶„ í™˜ë¶ˆ í›„ ì „ì²´ ì·¨ì†Œ ì—¬ë¶€ íŒë‹¨ìš©) -->
    <select id="countPaidDetails" parameterType="int" resultType="int">
        SELECT COUNT(*)
        FROM payment_detail
        WHERE payment_id = #{payment_id}
          AND status = 'paid'
    </select>
    
        <!-- ==========================================================
         ðŸ”¥ ë¶€ë¶„ í™˜ë¶ˆì— í•„ìš”í•œ íŠ¹ì • ë”± 1ê°œì˜ detail ì¡°íšŒ
         (payment_id + lecture_num ì¡°í•©)
    ========================================================== -->
    <select id="getDetailByPaymentAndLecture" resultType="com.itwillbs.domain.PaymentDetailVO">
        SELECT
            detail_id,
            payment_id,
            lecture_num,
            original_price,
            sale_price,
            used_points,
            saved_points,
            status
        FROM payment_detail
        WHERE payment_id = #{payment_id}
          AND lecture_num = #{lecture_num}
        LIMIT 1
    </select>

</mapper>