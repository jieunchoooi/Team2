<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.PaymentMapper">

    <!-- ✅ 결제 내역 저장 -->
    <insert id="insertPayment" parameterType="com.itwillbs.domain.PaymentVO"
            useGeneratedKeys="true" keyProperty="payment_id">
        INSERT INTO payment (
            user_num,
            amount,
            used_points,
            saved_points,
            status,
            imp_uid,
            merchant_uid,
            created_at
        )
        VALUES (
            #{user_num},
            #{amount},
            #{used_points},
            #{saved_points},
            'paid',
            #{imp_uid},
            #{merchant_uid},
            NOW()
        )
    </insert>

    <!-- ✅ imp_uid 중복 체크 -->
    <select id="checkDuplicateImpUid" parameterType="string" resultType="int">
        SELECT COUNT(*) FROM payment WHERE imp_uid = #{impUid}
    </select>

    <!-- ✅ 회원 누적 결제금액 조회 -->
    <select id="getUserTotalPayment" parameterType="int" resultType="int">
        SELECT IFNULL(SUM(amount), 0)
        FROM payment
        WHERE user_num = #{userNum}
          AND status = 'paid'
    </select>

    
      <!-- ✅ 트랜잭션 테스트용 임시 INSERT -->
 <insert id="insertPaymentForTest">
  INSERT INTO payment (
    user_num, amount, used_points, saved_points, status, imp_uid, merchant_uid, created_at
  ) VALUES (
    1, 10000, 0, 0, 'paid', 'imp_test_12345', 'M12345678953', NOW()
  )
</insert>

  <!-- =========================================================
         1) 특정 회원의 결제 목록 조회
         ========================================================= -->
    <select id="getPaymentList" parameterType="int"
            resultType="com.itwillbs.domain.PaymentVO">

        SELECT 
            p.payment_id,
            p.user_num,
            p.amount,
            p.used_points,
            p.saved_points,
            p.status,
            p.imp_uid,
            p.merchant_uid,
            p.created_at,

            u.user_name,
            u.user_email,

            (
                SELECT GROUP_CONCAT(l.lecture_title SEPARATOR ', ')
                FROM enrollment e
                LEFT JOIN lecture l ON e.lecture_num = l.lecture_num
                WHERE e.payment_id = p.payment_id
            ) AS lectureTitles

        FROM payment p
        LEFT JOIN user u ON p.user_num = u.user_num
        WHERE p.user_num = #{user_num}
        ORDER BY p.payment_id DESC;

    </select>

    <!-- =========================================================
         2) 특정 결제 상세 조회
         ========================================================= -->
    <select id="getPayment" parameterType="int"
            resultType="com.itwillbs.domain.PaymentVO">

        SELECT 
            p.payment_id,
            p.user_num,
            p.amount,
            p.used_points,
            p.saved_points,
            p.status,
            p.imp_uid,
            p.merchant_uid,
            p.created_at,

            u.user_name,
            u.user_email,

            (
                SELECT GROUP_CONCAT(l.lecture_title SEPARATOR ', ')
                FROM enrollment e
                LEFT JOIN lecture l ON e.lecture_num = l.lecture_num
                WHERE e.payment_id = p.payment_id
            ) AS lectureTitles

        FROM payment p
        LEFT JOIN user u ON p.user_num = u.user_num
        WHERE p.payment_id = #{payment_id};

    </select>
 <!-- 1. 결제 단건 조회 -->
    <select id="getPaymentById" parameterType="int" resultType="com.itwillbs.domain.PaymentVO">
        SELECT *
        FROM payment
        WHERE payment_id = #{payment_id}
    </select>

    <!-- 2. 결제 상태 'cancelled'로 변경 -->
    <update id="updatePaymentStatusRefund" parameterType="int">
        UPDATE payment
        SET status = 'cancelled'
        WHERE payment_id = #{payment_id}
    </update>

   

</mapper>
