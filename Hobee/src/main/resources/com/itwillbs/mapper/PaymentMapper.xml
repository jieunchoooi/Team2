<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.PaymentMapper">

	<!-- ============================================================ 
				üìå PaymentList 
		Ï†ÑÏö© ResultMap (Î¶¨Ïä§Ìä∏ ÌéòÏù¥ÏßÄ) - payment 1Í±¥Ïóê Ïó¨Îü¨ Í∞ïÏùòÍ∞Ä JOINÎêòÎØÄÎ°ú Î¶¨Ïä§Ìä∏Î°ú Îß§Ìïë 
		============================================================ -->
	<resultMap id="PaymentListMap"
		type="com.itwillbs.domain.PaymentVO">

		<!-- Îã®Ïùº Í≤∞Ï†ú Ï†ïÎ≥¥ -->
		<id property="payment_id" column="payment_id" />
		<result property="user_num" column="user_num" />
		<result property="amount" column="amount" />
		<result property="used_points" column="used_points" />
		<result property="saved_points" column="saved_points" />
		<result property="status" column="status" />
		<result property="imp_uid" column="imp_uid" />
		<result property="merchant_uid" column="merchant_uid" />
		<result property="created_at" column="created_at" />

		<!-- ÌöåÏõê Ï†ïÎ≥¥ -->
		<result property="user_name" column="user_name" />
		<result property="user_email" column="user_email" />

		<!-- Í∞ïÏùò Ï†ïÎ≥¥ Î¶¨Ïä§Ìä∏ -->
		<collection property="lectureNumList" ofType="int">
			<result column="lecture_num" />
		</collection>

		<collection property="lectureTitleList" ofType="string">
			<result column="lecture_title" />
		</collection>

		<collection property="lecturePriceList" ofType="int">
			<result column="lecture_price" />
		</collection>

	</resultMap>

<!-- ============================================================
     üìå PaymentDetailMap
     Í≤∞Ï†ú 1Í±¥(PaymentVO) + Ìï¥Îãπ Í≤∞Ï†úÏóê Ìè¨Ìï®Îêú Í∞ïÏùò ÏÉÅÏÑ∏Ï†ïÎ≥¥(PaymentDetailVO Î¶¨Ïä§Ìä∏)
      Íµ¨Ï°∞:
     PaymentVO
       List<PaymentDetailVO> details   ‚Üê 1:N Íµ¨Ï°∞ (Ï†ïÏÑù MyBatis Î∞©Ïãù)
    Ïû•Ï†ê:
        5Í∞úÏùò Í∞ïÏùòÍ∞Ä ÏûàÏúºÎ©¥ details ÏïàÏóê PaymentDetailVO 5Í∞úÍ∞Ä 100% Ï†ïÌôïÌûà Îã¥ÍπÄ
        Í∞ïÏùòÎ™Ö/Í∞ÄÍ≤©/ÏÉÅÌÉúÍ∞Ä ÏÑúÎ°ú Íº¨Ïù¥Í±∞ÎÇò 1Í∞úÎßå Îì§Ïñ¥Ïò§Îäî Î¨∏Ï†ú ÏôÑÏ†Ñ Ìï¥Í≤∞
        Î∂ÄÎ∂ÑÌôòÎ∂à/Ï†ÑÏ≤¥ÌôòÎ∂à ÌåêÎã®ÏóêÎèÑ ÏµúÏ†ÅÌôîÎê®
=============================================================== -->

<resultMap id="PaymentDetailMap" type="com.itwillbs.domain.PaymentVO">

    <id property="payment_id" column="payment_id"/>
    <result property="user_num" column="user_num"/>
    <result property="amount" column="amount"/>
    <result property="used_points" column="used_points"/>
    <result property="saved_points" column="saved_points"/>
    <result property="status" column="payment_status"/>
    <result property="imp_uid" column="imp_uid"/>
    <result property="merchant_uid" column="merchant_uid"/>
    <result property="created_at" column="created_at"/>

    <result property="user_name" column="user_name"/>
    <result property="user_email" column="user_email"/>

    <collection property="details" ofType="com.itwillbs.domain.PaymentDetailVO">
        <id property="detail_id" column="detail_id"/>
        
        <!-- payment_detail -->
        <result property="payment_id" column="detail_payment_id"/>
        <result property="lecture_num" column="lecture_num"/>
        <result property="original_price" column="original_price"/>
        <result property="sale_price" column="sale_price"/>
        <result property="used_points" column="detail_used_points"/>
        <result property="saved_points" column="detail_saved_points"/>
        <result property="status" column="detail_status"/>
        <result property="created_at" column="detail_created_at"/>

        <!-- lecture JOIN -->
        <result property="lecture_title" column="lecture_title"/>
        <result property="lecture_author" column="lecture_author"/>
        <result property="lecture_img" column="lecture_img"/>
        <result property="lecture_price" column="lecture_price"/>

    </collection>
</resultMap>





	<!-- ============================================================ 
							Í≤∞Ï†ú INSERT 
		============================================================ -->
	<insert id="insertPayment"
		parameterType="com.itwillbs.domain.PaymentVO">
		INSERT INTO payment (
		user_num, amount, used_points, saved_points,
		status, imp_uid, merchant_uid, created_at
		)
		VALUES (
		#{user_num}, #{amount}, #{used_points}, #{saved_points},
		#{status}, #{imp_uid}, #{merchant_uid}, NOW()
		);
		<selectKey resultType="int" keyProperty="payment_id"
			order="AFTER">
			SELECT LAST_INSERT_ID();
		</selectKey>
	</insert>



	<!-- ============================================================ 
								imp_uid Ï§ëÎ≥µ Ï≤¥ÌÅ¨ 
		============================================================ -->
	<select id="checkDuplicateImpUid" parameterType="String"
		resultType="int">
		SELECT COUNT(*) FROM payment WHERE imp_uid = #{impUid};
	</select>



	<!-- ============================================================ üìå Í≤∞Ï†ú 
					Î¶¨Ïä§Ìä∏ Ï°∞Ìöå (PaymentListMap Ï†ÅÏö©) 
		============================================================ -->
	<select id="getPaymentList" parameterType="int"
		resultMap="PaymentListMap">

		SELECT
		p.payment_id,
		p.user_num,
		p.amount,
		p.used_points,
		p.saved_points,
		p.status,
		p.imp_uid,
		p.merchant_uid,
		p.created_at,

		u.user_name,
		u.user_email,

		l.lecture_num,
		l.lecture_title,
		l.lecture_price

		FROM payment p
		LEFT JOIN user u ON p.user_num = u.user_num
		LEFT JOIN enrollment e ON p.payment_id = e.payment_id
		LEFT JOIN lecture l ON e.lecture_num = l.lecture_num

		WHERE p.user_num = #{user_num}
		ORDER BY p.payment_id DESC;

	</select>



	<!-- ============================================================ üìå ÏÉÅÏÑ∏ 
						Ï°∞Ìöå ‚Äî PaymentDetailMap ÏÇ¨Ïö© 
		============================================================ -->
	<select id="getPayment" parameterType="int" resultMap="PaymentDetailMap">

    SELECT
        -- payment
        p.payment_id,
        p.user_num,
        p.amount,
        p.used_points,
        p.saved_points,
        p.status              AS payment_status,
        p.imp_uid,
        p.merchant_uid,
        p.created_at,

        -- user
        u.user_name,
        u.user_email,

        -- payment_detail
        d.detail_id,
        d.payment_id          AS detail_payment_id,
        d.lecture_num,
        d.original_price,
        d.sale_price,
        d.used_points         AS detail_used_points,
        d.saved_points        AS detail_saved_points,
        d.status              AS detail_status,
        d.created_at          AS detail_created_at,

        -- lecture JOIN (Ïã§Ï†ú ÌÖåÏù¥Î∏î Í∏∞Ï§Ä)
        l.lecture_title,
        l.lecture_author,
        l.lecture_img,
        l.lecture_price

    FROM payment p
    JOIN user u
        ON p.user_num = u.user_num
    JOIN payment_detail d
        ON p.payment_id = d.payment_id
    JOIN lecture l
        ON d.lecture_num = l.lecture_num

    WHERE p.payment_id = #{payment_id}

</select>



	<!-- ============================================================ 
					ÌôòÎ∂à verify Ïö© Îã®Í±¥ Ï°∞Ìöå 
	============================================================ -->
	<select id="getPaymentById" parameterType="int"
		resultType="com.itwillbs.domain.PaymentVO">
		SELECT *
		FROM payment
		WHERE payment_id = #{payment_id};
	</select>



	<!-- ============================================================ 
					Í≤∞Ï†ú ÏÉÅÌÉú Î≥ÄÍ≤Ω ‚Üí refunded 
	============================================================ -->
	<update id="updatePaymentStatusRefund" parameterType="int">
		UPDATE payment
		SET status = 'refunded'
		WHERE payment_id = #{payment_id};
	</update>



	<!-- ============================================================ 
						Ïú†Ï†Ä Ï¥ù Í≤∞Ï†ú Í∏àÏï° 
	============================================================ -->
	<select id="getUserTotalPayment" parameterType="int"
		resultType="int">
		SELECT COALESCE(SUM(amount), 0)
		FROM payment
		WHERE user_num = #{user_num}
		AND status = 'paid';
	</select>

</mapper>
