<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.PaymentMapper">

    <!-- ============================================================
         ðŸ“Œ PaymentList ì „ìš© ResultMap (ë¦¬ìŠ¤íŠ¸ íŽ˜ì´ì§€)
         - payment 1ê±´ì— ì—¬ëŸ¬ ê°•ì˜ê°€ JOINë˜ë¯€ë¡œ ë¦¬ìŠ¤íŠ¸ë¡œ ë§¤í•‘
       ============================================================ -->
    <resultMap id="PaymentListMap" type="com.itwillbs.domain.PaymentVO">

        <!-- ë‹¨ì¼ ê²°ì œ ì •ë³´ -->
        <id property="payment_id" column="payment_id"/>
        <result property="user_num" column="user_num"/>
        <result property="amount" column="amount"/>
        <result property="used_points" column="used_points"/>
        <result property="saved_points" column="saved_points"/>
        <result property="status" column="status"/>
        <result property="imp_uid" column="imp_uid"/>
        <result property="merchant_uid" column="merchant_uid"/>
        <result property="created_at" column="created_at"/>

        <!-- íšŒì› ì •ë³´ -->
        <result property="user_name" column="user_name"/>
        <result property="user_email" column="user_email"/>

        <!-- ê°•ì˜ ì •ë³´ ë¦¬ìŠ¤íŠ¸ -->
        <collection property="lectureNumList" ofType="int">
            <result column="lecture_num"/>
        </collection>

        <collection property="lectureTitleList" ofType="string">
            <result column="lecture_title"/>
        </collection>

        <collection property="lecturePriceList" ofType="int">
            <result column="lecture_price"/>
        </collection>

    </resultMap>



    <!-- ============================================================
         ðŸ“Œ ìƒì„¸ ì¡°íšŒ ì „ìš© ResultMap (ëª¨ë‹¬ ìƒì„¸)
         - ë¦¬ìŠ¤íŠ¸ íŽ˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ ë¦¬ìŠ¤íŠ¸ ë§¤í•‘
       ============================================================ -->
    <resultMap id="PaymentDetailMap" type="com.itwillbs.domain.PaymentVO">

        <!-- ë‹¨ì¼ ê²°ì œ ì •ë³´ -->
        <id property="payment_id" column="payment_id"/>
        <result property="user_num" column="user_num"/>
        <result property="amount" column="amount"/>
        <result property="used_points" column="used_points"/>
        <result property="saved_points" column="saved_points"/>
        <result property="status" column="status"/>
        <result property="imp_uid" column="imp_uid"/>
        <result property="merchant_uid" column="merchant_uid"/>
        <result property="created_at" column="created_at"/>

        <!-- íšŒì› ì •ë³´ -->
        <result property="user_name" column="user_name"/>
        <result property="user_email" column="user_email"/>

        <!-- ê°•ì˜ ì •ë³´ ë¦¬ìŠ¤íŠ¸ -->
        <collection property="lectureNumList" ofType="int">
            <result column="lecture_num"/>
        </collection>

        <collection property="lectureTitleList" ofType="string">
            <result column="lecture_title"/>
        </collection>

        <collection property="lecturePriceList" ofType="int">
            <result column="lecture_price"/>
        </collection>

    </resultMap>



    <!-- ============================================================
         ê²°ì œ INSERT
       ============================================================ -->
    <insert id="insertPayment" parameterType="com.itwillbs.domain.PaymentVO">
        INSERT INTO payment (
            user_num, amount, used_points, saved_points,
            status, imp_uid, merchant_uid, created_at
        )
        VALUES (
            #{user_num}, #{amount}, #{used_points}, #{saved_points},
            #{status}, #{imp_uid}, #{merchant_uid}, NOW()
        );
        <selectKey resultType="int" keyProperty="payment_id" order="AFTER">
            SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>



    <!-- ============================================================
         imp_uid ì¤‘ë³µ ì²´í¬
       ============================================================ -->
    <select id="checkDuplicateImpUid" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM payment WHERE imp_uid = #{impUid};
    </select>



    <!-- ============================================================
         ðŸ“Œ ê²°ì œ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ (PaymentListMap ì ìš©)
       ============================================================ -->
    <select id="getPaymentList" parameterType="int" resultMap="PaymentListMap">

        SELECT
            p.payment_id,
            p.user_num,
            p.amount,
            p.used_points,
            p.saved_points,
            p.status,
            p.imp_uid,
            p.merchant_uid,
            p.created_at,

            u.user_name,
            u.user_email,

            l.lecture_num,
            l.lecture_title,
            l.lecture_price

        FROM payment p
        LEFT JOIN user u ON p.user_num = u.user_num
        LEFT JOIN enrollment e ON p.payment_id = e.payment_id
        LEFT JOIN lecture l ON e.lecture_num = l.lecture_num

        WHERE p.user_num = #{user_num}
        ORDER BY p.payment_id DESC;

    </select>



    <!-- ============================================================
         ðŸ“Œ ìƒì„¸ ì¡°íšŒ â€” PaymentDetailMap ì‚¬ìš©
       ============================================================ -->
    <select id="getPayment" parameterType="int" resultMap="PaymentDetailMap">

        SELECT
            p.payment_id,
            p.user_num,
            p.amount,
            p.used_points,
            p.saved_points,
            p.status,
            p.imp_uid,
            p.merchant_uid,
            p.created_at,

            u.user_name,
            u.user_email,

            l.lecture_num,
            l.lecture_title,
            l.lecture_price

        FROM payment p
        LEFT JOIN user u ON p.user_num = u.user_num
        LEFT JOIN enrollment e ON p.payment_id = e.payment_id
        LEFT JOIN lecture l ON e.lecture_num = l.lecture_num

        WHERE p.payment_id = #{payment_id};

    </select>



    <!-- ============================================================
         í™˜ë¶ˆ verify ìš© ë‹¨ê±´ ì¡°íšŒ
       ============================================================ -->
    <select id="getPaymentById" parameterType="int" resultType="com.itwillbs.domain.PaymentVO">
        SELECT *
        FROM payment
        WHERE payment_id = #{payment_id};
    </select>



    <!-- ============================================================
         ê²°ì œ ìƒíƒœ ë³€ê²½ â†’ refunded
       ============================================================ -->
    <update id="updatePaymentStatusRefund" parameterType="int">
        UPDATE payment
        SET status = 'refunded'
        WHERE payment_id = #{payment_id};
    </update>



    <!-- ============================================================
         ìœ ì € ì´ ê²°ì œ ê¸ˆì•¡
       ============================================================ -->
    <select id="getUserTotalPayment" parameterType="int" resultType="int">
        SELECT COALESCE(SUM(amount), 0)
        FROM payment
        WHERE user_num = #{user_num}
          AND status = 'paid';
    </select>

</mapper>
