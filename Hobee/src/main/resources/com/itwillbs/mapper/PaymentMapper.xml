<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.PaymentMapper">

    <!-- =========================================================
         결제 INSERT
         ========================================================= -->
    <insert id="insertPayment" parameterType="com.itwillbs.domain.PaymentVO">
        INSERT INTO payment (
            user_num, amount, used_points, saved_points,
            status, imp_uid, merchant_uid, created_at
        )
        VALUES (
            #{user_num}, #{amount}, #{used_points}, #{saved_points},
            #{status}, #{imp_uid}, #{merchant_uid}, NOW()
        );
        <selectKey resultType="int" keyProperty="payment_id" order="AFTER">
            SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>


    <!-- =========================================================
         imp_uid 중복 체크
         ========================================================= -->
    <select id="checkDuplicateImpUid" parameterType="String" resultType="int">
        SELECT COUNT(*) FROM payment WHERE imp_uid = #{impUid};
    </select>


    <!-- =========================================================
         특정 회원 전체 누적 결제 금액 (등급 계산용)
         ========================================================= -->
    <select id="getUserTotalPayment" parameterType="int" resultType="int">
        SELECT COALESCE(SUM(amount), 0)
        FROM payment
        WHERE user_num = #{userNum}
          AND status = 'paid';
    </select>


    <!-- =========================================================
         특정 회원 결제 목록 (리스트 페이지용)
         ========================================================= -->
    <select id="getPaymentList" parameterType="int" resultType="com.itwillbs.domain.PaymentVO">

        SELECT 
            p.payment_id,
            p.user_num,
            p.amount,
            p.used_points,
            p.saved_points,
            p.status,
            p.imp_uid,
            p.merchant_uid,
            p.created_at,

            u.user_name,
            u.user_email,

            (
                SELECT GROUP_CONCAT(l.lecture_title SEPARATOR ', ')
                FROM enrollment e
                LEFT JOIN lecture l ON e.lecture_num = l.lecture_num
                WHERE e.payment_id = p.payment_id
            ) AS lectureTitles

        FROM payment p
        LEFT JOIN user u ON p.user_num = u.user_num
        WHERE p.user_num = #{user_num}
        ORDER BY p.payment_id DESC;
    </select>


    <!-- =========================================================
         특정 결제 상세 (상세페이지)
         ========================================================= -->
    <select id="getPayment" parameterType="int" resultType="com.itwillbs.domain.PaymentVO">

    SELECT 
        p.payment_id,
        p.user_num,
        p.amount,
        p.used_points,
        p.saved_points,
        p.status,
        p.imp_uid,
        p.merchant_uid,
        p.created_at,

        u.user_name,
        u.user_email,

        (
            SELECT GROUP_CONCAT(l.lecture_title SEPARATOR ', ')
            FROM enrollment e
            LEFT JOIN lecture l ON e.lecture_num = l.lecture_num
            WHERE e.payment_id = p.payment_id
        ) AS lectureTitles,

        (
            SELECT GROUP_CONCAT(l.lecture_price SEPARATOR ',')
            FROM enrollment e
            LEFT JOIN lecture l ON e.lecture_num = l.lecture_num
            WHERE e.payment_id = p.payment_id
        ) AS lecturePrices

    FROM payment p
    LEFT JOIN user u ON p.user_num = u.user_num
    WHERE p.payment_id = #{payment_id};

</select>



    <!-- =========================================================
         환불 트랜잭션용 단건 조회 (created_at 포함)
         ========================================================= -->
    <select id="getPaymentById" parameterType="int" resultType="com.itwillbs.domain.PaymentVO">
        SELECT *
        FROM payment
        WHERE payment_id = #{payment_id};
    </select>


    <!-- =========================================================
         결제 상태 → cancelled
         ========================================================= -->
    <update id="updatePaymentStatusRefund" parameterType="int">
        UPDATE payment
        SET status = 'cancelled'
        WHERE payment_id = #{payment_id};
    </update>

</mapper>
