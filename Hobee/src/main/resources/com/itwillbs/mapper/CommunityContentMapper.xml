<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.CommunityContentMapper">

    <!-- ======================================================
         0. ë‹¨ì¼ ì¹´ìš´íŠ¸
    ====================================================== -->
    <select id="getCommunityCount" resultType="int">
        SELECT COUNT(*)
        FROM community_content
        WHERE category_main_num = #{category_main_num}
    </select>


    <!-- ======================================================
         ðŸ”¥ 1. í•«í† í”½ (summary = 120ìž)
         â€» CDATA ì ìš©
    ====================================================== -->
    <!-- ======================================================
     ðŸ”¥ 1. í•«í† í”½ (summary = 120ìž, íŠ¸ë Œë“œ ì ìˆ˜ ì ìš©)
     â€» CDATA ì ìš©
====================================================== -->
<select id="getHotTopicList"
        resultType="com.itwillbs.domain.CommunityContentVO">
    <![CDATA[
    SELECT
        c.post_id,
        c.title,

        -- ë³¸ë¬¸ ìš”ì•½ (120ìž)
        SUBSTRING(
            REGEXP_REPLACE(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(c.content, '<[^>]*>', ''),
                    '[<>]', ''
                ),
                '&[^;]+;', ''
            ),
            1, 120
        ) AS summary,

        COUNT(DISTINCT l.like_id) AS like_count,
        COUNT(DISTINCT cc.comment_id) AS comment_count,
        c.views,
        c.created_at,

        u.user_name,
        u.user_file,
        cm.category_main_name AS category_name,

        -- â­ íŠ¸ë Œë“œ ì ìˆ˜ (ì¡°íšŒìš© í•„ë“œ)
        (
            (COUNT(DISTINCT l.like_id) * 4)
            + (COUNT(DISTINCT cc.comment_id) * 3)
            + (c.views * 0.2)
        )
        /
        POW(
            TIMESTAMPDIFF(HOUR, c.created_at, NOW()) + 1,
            1.3
        ) AS trendingScore

    FROM community_content c
    JOIN user u
        ON c.user_num = u.user_num
    LEFT JOIN category_main cm
        ON c.category_main_num = cm.category_main_num

    LEFT JOIN community_content_like l
        ON l.post_id = c.post_id

    LEFT JOIN community_comment cc
        ON cc.post_id = c.post_id

    -- ðŸ”¥ ê¸°ì¡´ 2ì‹œê°„ â†’ 24ì‹œê°„ìœ¼ë¡œ í™•ìž¥
    WHERE c.created_at >= NOW() - INTERVAL 24 HOUR

    GROUP BY c.post_id

    ORDER BY trendingScore DESC

    LIMIT 10
    ]]>
</select>




    <!-- ======================================================
         2. ì¸ê¸°ê¸€ (summary = 60ìž)
         â€» CDATA ì ìš©
    ====================================================== -->
    <select id="getPopularPosts" resultType="com.itwillbs.domain.CommunityContentVO">
        <![CDATA[
        SELECT
            c.post_id,
            c.title,
            c.views,
            c.created_at,
            u.user_name,
            u.user_file,
            cm.category_main_name,

            -- summary 60ìž
            SUBSTRING(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(
                        REGEXP_REPLACE(c.content, '<[^>]*>', ''),
                        '[<>]', ''
                    ),
                    '&[^;]+;', ''
                ),
                1, 60
            ) AS summary,

            (SELECT COUNT(*)
             FROM community_content_like l
             WHERE l.post_id = c.post_id AND l.is_like = 1) AS like_count

        FROM community_content c
        JOIN user u ON c.user_num = u.user_num
        JOIN category_main cm ON c.category_main_num = cm.category_main_num

        ORDER BY like_count DESC, c.views DESC
        LIMIT 5
        ]]>
    </select>



    <!-- ======================================================
         3. ê²Œì‹œê¸€ ì¢‹ì•„ìš”/ì‹«ì–´ìš”
    ====================================================== -->
    <select id="getUserPostReaction" resultType="int">
        SELECT is_like
        FROM community_content_like
        WHERE post_id = #{post_id}
          AND user_num = #{user_num}
    </select>

    <insert id="insertPostReaction">
        INSERT INTO community_content_like (post_id, user_num, is_like)
        VALUES (#{post_id}, #{user_num}, #{is_like})
    </insert>

    <update id="updatePostReaction">
        UPDATE community_content_like
        SET is_like = #{is_like}
        WHERE post_id = #{post_id}
          AND user_num = #{user_num}
    </update>

    <delete id="deletePostReaction">
        DELETE FROM community_content_like
        WHERE post_id = #{post_id}
          AND user_num = #{user_num}
    </delete>

    <select id="getPostReactionCount" resultType="com.itwillbs.domain.ReactionCountVO">
        SELECT
            SUM(CASE WHEN is_like = 1 THEN 1 ELSE 0 END) AS like_count,
            SUM(CASE WHEN is_like = 0 THEN 1 ELSE 0 END) AS dislike_count
        FROM community_content_like
        WHERE post_id = #{post_id}
    </select>



    <!-- ======================================================
         4. ìƒë‹¨ ë©”ì¸ ì¹´í…Œê³ ë¦¬ ë¦¬ìŠ¤íŠ¸
    ====================================================== -->
    <select id="getCategoryMainList" resultType="com.itwillbs.domain.CommunityContentVO">
        SELECT
            category_main_num,
            category_main_name
        FROM category_main
        ORDER BY category_main_num ASC
    </select>



    <!-- ======================================================
         5. ê²Œì‹œê¸€ ëª©ë¡ (summary = 120ìž)
         â€» CDATA ì ìš©
    ====================================================== -->
    <select id="getCommunityList" resultType="com.itwillbs.domain.CommunityContentVO">
        <![CDATA[
        SELECT
            c.post_id,
            c.title,
            c.content,
            c.user_num,
            c.tag,
            c.views,
            c.is_visible,
            c.is_deleted,
            c.category_main_num,
            c.lecture_num,
            c.category_id,
            c.created_at,
            c.updated_at,

            u.user_name,
            u.user_file,
            cm.category_main_name,
            cc.category_name AS category_name,
            cc.category_key AS category_key,

            -- summary 120ìž
            SUBSTRING(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(
                        REGEXP_REPLACE(c.content, '<[^>]*>', ''),
                        '[<>]', ''
                    ),
                    '&[^;]+;', ''
                ),
                1, 120
            ) AS summary,

            (SELECT COUNT(*)
             FROM community_comment cc2
             WHERE cc2.post_id = c.post_id AND cc2.is_deleted = 0) AS comment_count,

            (SELECT COUNT(*)
             FROM community_content_like l1
             WHERE l1.post_id = c.post_id AND l1.is_like = 1) AS like_count,

            (SELECT COUNT(*)
             FROM community_content_like l2
             WHERE l2.post_id = c.post_id AND l2.is_like = 0) AS dislike_count

        FROM community_content c
        JOIN user u ON c.user_num = u.user_num
        JOIN category_main cm ON c.category_main_num = cm.category_main_num
        LEFT JOIN community_category cc ON c.category_id = cc.category_id
        ]]>
    </select>



    <!-- ======================================================
         6. ì´ ê°œìˆ˜ (ì´ê±´ summary ì—†ìŒ)
    ====================================================== -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM community_content c
        LEFT JOIN community_category cc ON c.category_id = cc.category_id

        <where>
            <if test="category_id != null">
                AND c.category_id = #{category_id}
            </if>

            <if test="category_main_num != null">
                AND c.category_main_num = #{category_main_num}
            </if>

            <choose>
                <when test="period == 'today'">
                    AND DATE(c.created_at) = CURDATE()
                </when>
                <when test="period == 'week'">
                    AND c.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
                </when>
                <when test="period == 'month'">
                    AND c.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
                </when>
            </choose>

            <if test="keyword != null and keyword != ''">
                <choose>
                    <when test="searchType == 'title'">
                        AND c.title LIKE CONCAT('%', #{keyword}, '%')
                    </when>

                    <when test="searchType == 'titleContent'">
                        AND (c.title LIKE CONCAT('%', #{keyword}, '%')
                        OR c.content LIKE CONCAT('%', #{keyword}, '%'))
                    </when>

                    <when test="searchType == 'writer'">
                        AND u.user_name LIKE CONCAT('%', #{keyword}, '%')
                    </when>

                    <when test="searchType == 'comment'">
                        AND co.content LIKE CONCAT('%', #{keyword}, '%')
                    </when>
                </choose>
            </if>
        </where>
    </select>

</mapper>
