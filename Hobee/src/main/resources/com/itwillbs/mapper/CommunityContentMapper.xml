<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.CommunityContentMapper">

    <!-- ======================================================
         0. Îã®Ïùº Ïπ¥Ïö¥Ìä∏
    ====================================================== -->
    <select id="getCommunityCount" resultType="int">
        SELECT COUNT(*)
        FROM community_content
        WHERE category_main_num = #{category_main_num}
    </select>


    <!-- ======================================================
         üî• 1. Ìï´ÌÜ†ÌîΩ (summary = 120Ïûê)
         ‚Äª CDATA Ï†ÅÏö©
    ====================================================== -->
    <!-- ======================================================
     üî• 1. Ìï´ÌÜ†ÌîΩ (summary = 120Ïûê, Ìä∏Î†åÎìú Ï†êÏàò Ï†ÅÏö©)
     ‚Äª CDATA Ï†ÅÏö©
====================================================== -->
<select id="getHotTopicList"
        resultType="com.itwillbs.domain.CommunityContentVO">
    <![CDATA[
    SELECT
        c.post_id,
        c.title,

        -- Î≥∏Î¨∏ ÏöîÏïΩ (120Ïûê)
        SUBSTRING(
            REGEXP_REPLACE(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(c.content, '<[^>]*>', ''),
                    '[<>]', ''
                ),
                '&[^;]+;', ''
            ),
            1, 120
        ) AS summary,

        COUNT(DISTINCT l.like_id) AS like_count,
        COUNT(DISTINCT cc.comment_id) AS comment_count,
        c.views,
        c.created_at,

        u.user_name,
        u.user_file,
        cm.category_main_name AS category_name,

        -- ‚≠ê Ìä∏Î†åÎìú Ï†êÏàò (Ï°∞ÌöåÏö© ÌïÑÎìú)
        (
            (COUNT(DISTINCT l.like_id) * 4)
            + (COUNT(DISTINCT cc.comment_id) * 3)
            + (c.views * 0.2)
        )
        /
        POW(
            TIMESTAMPDIFF(HOUR, c.created_at, NOW()) + 1,
            1.3
        ) AS trendingScore

    FROM community_content c
    JOIN user u
        ON c.user_num = u.user_num
    LEFT JOIN category_main cm
        ON c.category_main_num = cm.category_main_num

    LEFT JOIN community_content_like l
        ON l.post_id = c.post_id

    LEFT JOIN community_comment cc
        ON cc.post_id = c.post_id

    -- üî• Í∏∞Ï°¥ 2ÏãúÍ∞Ñ ‚Üí 24ÏãúÍ∞ÑÏúºÎ°ú ÌôïÏû•
    WHERE c.created_at >= NOW() - INTERVAL 24 HOUR

    GROUP BY c.post_id

    ORDER BY trendingScore DESC

    LIMIT 10
    ]]>
</select>




    <!-- ======================================================
         2. Ïù∏Í∏∞Í∏Ä (summary = 60Ïûê)
         ‚Äª CDATA Ï†ÅÏö©
    ====================================================== -->
    <select id="getPopularPosts" resultType="com.itwillbs.domain.CommunityContentVO">
        <![CDATA[
        SELECT
            c.post_id,
            c.title,
            c.views,
            c.created_at,
            u.user_name,
            u.user_file,
            cm.category_main_name,

            -- summary 60Ïûê
            SUBSTRING(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(
                        REGEXP_REPLACE(c.content, '<[^>]*>', ''),
                        '[<>]', ''
                    ),
                    '&[^;]+;', ''
                ),
                1, 60
            ) AS summary,

            (SELECT COUNT(*)
             FROM community_content_like l
             WHERE l.post_id = c.post_id AND l.is_like = 1) AS like_count

        FROM community_content c
        JOIN user u ON c.user_num = u.user_num
        JOIN category_main cm ON c.category_main_num = cm.category_main_num

        ORDER BY like_count DESC, c.views DESC
        LIMIT 5
        ]]>
    </select>



    <!-- ======================================================
         3. Í≤åÏãúÍ∏Ä Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî
    ====================================================== -->
    <select id="getUserPostReaction" resultType="int">
        SELECT is_like
        FROM community_content_like
        WHERE post_id = #{post_id}
          AND user_num = #{user_num}
    </select>

    <insert id="insertPostReaction">
        INSERT INTO community_content_like (post_id, user_num, is_like)
        VALUES (#{post_id}, #{user_num}, #{is_like})
    </insert>

    <update id="updatePostReaction">
        UPDATE community_content_like
        SET is_like = #{is_like}
        WHERE post_id = #{post_id}
          AND user_num = #{user_num}
    </update>

    <delete id="deletePostReaction">
        DELETE FROM community_content_like
        WHERE post_id = #{post_id}
          AND user_num = #{user_num}
    </delete>

    <select id="getPostReactionCount" resultType="com.itwillbs.domain.ReactionCountVO">
        SELECT
            SUM(CASE WHEN is_like = 1 THEN 1 ELSE 0 END) AS like_count,
            SUM(CASE WHEN is_like = 0 THEN 1 ELSE 0 END) AS dislike_count
        FROM community_content_like
        WHERE post_id = #{post_id}
    </select>



    <!-- ======================================================
         4. ÏÉÅÎã® Î©îÏù∏ Ïπ¥ÌÖåÍ≥†Î¶¨ Î¶¨Ïä§Ìä∏
    ====================================================== -->
    <select id="getCategoryMainList" resultType="com.itwillbs.domain.CommunityContentVO">
        SELECT
            category_main_num,
            category_main_name
        FROM category_main
        ORDER BY category_main_num ASC
    </select>



    <!-- ======================================================
         5. Í≤åÏãúÍ∏Ä Î™©Î°ù (summary = 120Ïûê)
         ‚Äª CDATA Ï†ÅÏö©
    ====================================================== -->
   <select id="getCommunityList" resultType="com.itwillbs.domain.CommunityContentVO">

    <![CDATA[
    SELECT
        c.post_id,
        c.title,
        c.content,
        c.user_num,
        c.tag,
        c.views,
        c.is_visible,
        c.is_deleted,
        c.category_main_num,
        c.lecture_num,
        c.category_id,
        c.created_at,
        c.updated_at,

        u.user_name,
        u.user_file,
        cm.category_main_name,
        cc.category_name AS category_name,
        cc.category_key AS category_key,

        -- summary 120Ïûê (HTML Ï†úÍ±∞)
        SUBSTRING(
            REGEXP_REPLACE(
                REGEXP_REPLACE(
                    REGEXP_REPLACE(c.content, '<[^>]*>', ''),
                    '[<>]', ''
                ),
                '&[^;]+;', ''
            ),
            1, 120
        ) AS summary,

        (SELECT COUNT(*)
         FROM community_comment cc2
         WHERE cc2.post_id = c.post_id AND cc2.is_deleted = 0) AS comment_count,

        (SELECT COUNT(*)
         FROM community_content_like l1
         WHERE l1.post_id = c.post_id AND l1.is_like = 1) AS like_count

    FROM community_content c
    JOIN user u ON c.user_num = u.user_num
    JOIN category_main cm ON c.category_main_num = cm.category_main_num
    LEFT JOIN community_category cc ON c.category_id = cc.category_id
    ]]>

    <where>

        <if test="category_id != null">
            AND c.category_id = #{category_id}
        </if>

        <if test="category_main_num != null">
            AND c.category_main_num = #{category_main_num}
        </if>

        <choose>
            <when test="period == 'today'">
                AND DATE(c.created_at) = CURDATE()
            </when>
            <when test="period == 'week'">
                AND c.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
            </when>
            <when test="period == 'month'">
                AND c.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
            </when>
        </choose>

        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND c.title LIKE CONCAT('%', #{keyword}, '%')
                </when>

                <when test="searchType == 'titleContent'">
                    AND (c.title LIKE CONCAT('%', #{keyword}, '%')
                     OR c.content LIKE CONCAT('%', #{keyword}, '%'))
                </when>

                <when test="searchType == 'writer'">
                    AND u.user_name LIKE CONCAT('%', #{keyword}, '%')
                </when>

                <when test="searchType == 'comment'">
                    AND EXISTS (
                        SELECT 1
                        FROM community_comment co
                        WHERE co.post_id = c.post_id
                          AND co.is_deleted = 0
                          AND co.content LIKE CONCAT('%', #{keyword}, '%')
                    )
                </when>
            </choose>
        </if>

        AND c.is_deleted = 0
    </where>

    <choose>
        <when test="sort == 'views'">
            ORDER BY c.views DESC
        </when>
        <when test="sort == 'likes'">
            ORDER BY like_count DESC
        </when>
        <when test="sort == 'comments'">
            ORDER BY comment_count DESC
        </when>
        <otherwise>
            ORDER BY c.created_at DESC
        </otherwise>
    </choose>

    LIMIT #{amount} OFFSET #{offset}

</select>





    <!-- ======================================================
         6. Ï¥ù Í∞úÏàò (Ïù¥Í±¥ summary ÏóÜÏùå)
    ====================================================== -->
    <select id="getTotalCount" resultType="int">

    <![CDATA[
    SELECT COUNT(DISTINCT c.post_id)
    FROM community_content c
    JOIN user u ON c.user_num = u.user_num
    LEFT JOIN community_category cc ON c.category_id = cc.category_id
    LEFT JOIN community_comment co ON co.post_id = c.post_id
    ]]>

    <where>

        <if test="category_id != null">
            AND c.category_id = #{category_id}
        </if>

        <if test="category_main_num != null">
            AND c.category_main_num = #{category_main_num}
        </if>

        <choose>
            <when test="period == 'today'">
                AND DATE(c.created_at) = CURDATE()
            </when>
            <when test="period == 'week'">
                AND c.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
            </when>
            <when test="period == 'month'">
                AND c.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
            </when>
        </choose>

        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="searchType == 'title'">
                    AND c.title LIKE CONCAT('%', #{keyword}, '%')
                </when>

                <when test="searchType == 'titleContent'">
                    AND (c.title LIKE CONCAT('%', #{keyword}, '%')
                     OR c.content LIKE CONCAT('%', #{keyword}, '%'))
                </when>

                <when test="searchType == 'writer'">
                    AND u.user_name LIKE CONCAT('%', #{keyword}, '%')
                </when>

                <when test="searchType == 'comment'">
                    AND co.content LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </if>

        AND c.is_deleted = 0
    </where>

</select>

	<!-- ============================================================
     üìå Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏ Ï°∞Ìöå (CommunityContentVO Í∏∞Ï§Ä ÏôÑÏ†ÑÏ≤¥)
============================================================ -->
<select id="getPostDetail" resultType="com.itwillbs.domain.CommunityContentVO">

    SELECT 
        c.*,

        u.user_name,
        u.user_file,

        cc.category_name,
        cm.category_main_name,

        lec.lecture_title,

        /* üî• ÎåìÍ∏Ä Ïàò */
        (
            SELECT COUNT(*)
            FROM community_comment
            WHERE post_id = c.post_id
            AND is_deleted = 0
        ) AS comment_count,

        /* üî• Ï¢ãÏïÑÏöî / Ïã´Ïñ¥Ïöî */
        COALESCE(SUM(CASE WHEN cl.is_like = 1 THEN 1 END), 0) AS like_count,
        COALESCE(SUM(CASE WHEN cl.is_like = 0 THEN 1 END), 0) AS dislike_count

    FROM community_content c

        /* ÏûëÏÑ±Ïûê */
        JOIN user u
            ON c.user_num = u.user_num

        /* Ïπ¥ÌÖåÍ≥†Î¶¨ */
        JOIN community_category cc
            ON c.category_id = cc.category_id

        /* Î©îÏù∏ Ïπ¥ÌÖåÍ≥†Î¶¨ */
        LEFT JOIN category_main cm
            ON c.category_main_num = cm.category_main_num

        /* Í∞ïÏùò */
        LEFT JOIN lecture lec
            ON c.lecture_num = lec.lecture_num

        /* Ï¢ãÏïÑÏöî */
        LEFT JOIN community_content_like cl
            ON c.post_id = cl.post_id

    WHERE c.post_id = #{post_id}
    GROUP BY c.post_id;

</select>
	<!-- ============================================================
     üìå Í≤åÏãúÍ∏Ä ÎåìÍ∏Ä Ï†ÑÏ≤¥ Ï°∞Ìöå (Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî + ÏûëÏÑ±Ïûê Ìè¨Ìï®)
============================================================ -->
<select id="getCommentsByPostId" 
        resultType="com.itwillbs.domain.CommunityCommentVO">

    SELECT 
        c.comment_id,
        c.post_id,
        c.user_num,
        c.parent_id,
        c.content,
        c.is_deleted,
        c.created_at,
        c.updated_at,

        /* --------------------------
           ÏûëÏÑ±Ïûê JOIN
        -------------------------- */
        u.user_name,
        u.user_file,

        /* --------------------------
           ÎåìÍ∏Ä Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî Ïπ¥Ïö¥Ìä∏
        -------------------------- */
        COALESCE(SUM(CASE WHEN cl.is_like = 1 THEN 1 END), 0) AS like_count,
        COALESCE(SUM(CASE WHEN cl.is_like = 0 THEN 1 END), 0) AS dislike_count,

        /* --------------------------
           ÌòÑÏû¨ Ïú†Ï†Ä Î∞òÏùë(Ï¢ãÏïÑÏöî/Ïã´Ïñ¥Ïöî)
           ÌååÎùºÎØ∏ÌÑ∞: user_num (Î°úÍ∑∏Ïù∏Ìïú Ïú†Ï†Ä)
        -------------------------- */
        (
            SELECT cl2.is_like
            FROM community_comment_like cl2
            WHERE cl2.comment_id = c.comment_id
              AND cl2.user_num = #{user_num}
            LIMIT 1
        ) AS my_like_status

    FROM community_comment c

        /* ÏûëÏÑ±Ïûê */
        JOIN user u
            ON c.user_num = u.user_num

        /* ÎåìÍ∏Ä Ï¢ãÏïÑÏöî ÌÖåÏù¥Î∏î (LEFT JOIN ‚Üí Ï¢ãÏïÑÏöî ÏóÜÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú) */
        LEFT JOIN community_comment_like cl
            ON c.comment_id = cl.comment_id

    WHERE c.post_id = #{post_id}
      AND c.is_deleted = 0   <!-- üî• ÏÇ≠Ï†ú ÎåìÍ∏ÄÏùÄ Ï†úÏô∏ -->

    GROUP BY c.comment_id
    ORDER BY 
        c.parent_id ASC,   <!-- Î∂ÄÎ™® ÎåìÍ∏Ä Î®ºÏ†Ä -->
        c.comment_id ASC   <!-- Í∑∏ Îã§Ïùå ÎåÄÎåìÍ∏Ä -->
</select>
<!-- ============================================================
     üìå Í≤åÏãúÍ∏Ä Ï°∞ÌöåÏàò Ï¶ùÍ∞Ä
============================================================ -->
<update id="updateViewCount">
    UPDATE community_content
    SET views = views + 1
    WHERE post_id = #{post_id}
</update>

<!-- ============================================================
     üìå ÎåìÍ∏Ä Ï¢ãÏïÑÏöî Í∞úÏàò
============================================================ -->
<select id="getCommentLikeCount" resultType="int">
    SELECT COUNT(*)
    FROM community_comment_like
    WHERE comment_id = #{comment_id}
      AND is_like = 1
</select>

<!-- ============================================================
     üìå ÎåìÍ∏Ä Ïã´Ïñ¥Ïöî Í∞úÏàò
============================================================ -->
<select id="getCommentDislikeCount" resultType="int">
    SELECT COUNT(*)
    FROM community_comment_like
    WHERE comment_id = #{comment_id}
      AND is_like = 0
</select>
	
</mapper>
