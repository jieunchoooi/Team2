<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminPostMapper">

    <!-- ðŸ“Œ 1. ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ -->
    <select id="getPostDetail" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT 
            c.post_id,
            c.title,
            c.content,
            c.author,
            c.tag,
            c.views,
            c.is_visible,
            c.created_at,
            b.board_name
        FROM community_content c
        LEFT JOIN board_category b
            ON c.board_id = b.board_id
        WHERE c.post_id = #{post_id}
    </select>

    <!-- ðŸ“Œ 2. ê²Œì‹œê¸€ ê³µê°œ/ìˆ¨ê¹€ í† ê¸€ -->
    <update id="togglePostVisible">
        UPDATE community_content
        SET is_visible = CASE 
                            WHEN is_visible = 1 THEN 0 
                            ELSE 1 
                         END
        WHERE post_id = #{post_id}
    </update>

    <!-- ðŸ“Œ 3. ê²Œì‹œê¸€ ì‚­ì œ -->
    <delete id="deletePost">
        DELETE FROM community_content
        WHERE post_id = #{post_id}
    </delete>

    <!-- ðŸ“Œ 4. ì „ì²´ ê²Œì‹œê¸€ ê°œìˆ˜ -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*) 
        FROM community_content
    </select>


    <!-- ===========================================================
         ðŸ”¥ 5. ì •ë ¬ í¬í•¨ ì „ì²´ ëª©ë¡ (íŽ˜ì´ì§• + ì •ë ¬)
    ============================================================ -->
    <select id="getPostListPagingSorted" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT 
            c.post_id,
            c.title,
            c.content,
            c.author,
            c.tag,
            c.views,
            c.is_visible,
            c.created_at,
            b.board_name,
            (SELECT COUNT(*) FROM comment cm WHERE cm.post_id = c.post_id) AS reply_count
        FROM community_content c
        LEFT JOIN board_category b
            ON c.board_id = b.board_id
        
        <!-- ðŸ”¥ ì •ë ¬ ì¡°ê±´ -->
        <choose>
            <when test="sort == 'views'">
                ORDER BY c.views DESC
            </when>
            <when test="sort == 'reply'">
                ORDER BY reply_count DESC, c.post_id DESC
            </when>
            <when test="sort == 'visible'">
                ORDER BY c.is_visible DESC, c.post_id DESC
            </when>
            <otherwise>
                ORDER BY c.post_id DESC  <!-- ìµœì‹ ìˆœ -->
            </otherwise>
        </choose>

        LIMIT #{start}, #{amount}
    </select>


    <!-- ===========================================================
         ðŸ”¥ 6. ì •ë ¬ í¬í•¨ ê²€ìƒ‰ëœ ëª©ë¡ (íŽ˜ì´ì§• + ê²€ìƒ‰ + ì •ë ¬)
    ============================================================ -->
    <select id="getSearchPostListSorted" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT 
            c.post_id,
            c.title,
            c.content,
            c.author,
            c.tag,
            c.views,
            c.is_visible,
            c.created_at,
            b.board_name,
            (SELECT COUNT(*) FROM comment cm WHERE cm.post_id = c.post_id) AS reply_count
        FROM community_content c
        LEFT JOIN board_category b
            ON c.board_id = b.board_id

        WHERE 
            (#{type} = 'T' AND c.title LIKE CONCAT('%', #{keyword}, '%'))
            OR
            (#{type} = 'A' AND c.author LIKE CONCAT('%', #{keyword}, '%'))
            OR
            (#{type} = 'B' AND b.board_name LIKE CONCAT('%', #{keyword}, '%'))

        <!-- ðŸ”¥ ì •ë ¬ ì¡°ê±´ -->
        <choose>
            <when test="sort == 'views'">
                ORDER BY c.views DESC
            </when>
            <when test="sort == 'reply'">
                ORDER BY reply_count DESC, c.post_id DESC
            </when>
            <when test="sort == 'visible'">
                ORDER BY c.is_visible DESC, c.post_id DESC
            </when>
            <otherwise>
                ORDER BY c.post_id DESC  <!-- ìµœì‹ ìˆœ -->
            </otherwise>
        </choose>

        LIMIT #{start}, #{amount}
    </select>


    <!-- ðŸ“Œ 7. ê²€ìƒ‰ëœ ê²Œì‹œê¸€ ê°œìˆ˜ -->
    <select id="getSearchTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM community_content c
        LEFT JOIN board_category b 
            ON c.board_id = b.board_id
        WHERE 
            (#{type} = 'T' AND c.title LIKE CONCAT('%', #{keyword}, '%'))
            OR
            (#{type} = 'A' AND c.author LIKE CONCAT('%', #{keyword}, '%'))
            OR
            (#{type} = 'B' AND b.board_name LIKE CONCAT('%', #{keyword}, '%'))
    </select>
    
    <!-- ðŸ”¥ ì¼ê´„ ìˆ¨ê¹€ -->
<update id="batchHide">
    UPDATE community_content
    SET is_visible = 0
    WHERE post_id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
</update>

<!-- ðŸ”¥ ì¼ê´„ í‘œì‹œ -->
<update id="batchShow">
    UPDATE community_content
    SET is_visible = 1
    WHERE post_id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
</update>

<!-- ðŸ”¥ ì¼ê´„ ì‚­ì œ -->
<delete id="batchDelete">
    DELETE FROM community_content
    WHERE post_id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
        #{id}
    </foreach>
</delete>

<update id="updatePost">
    UPDATE community_content
    SET 
        title = #{title},
        content = #{content},
        updated_at = NOW()
    WHERE post_id = #{post_id}
</update>


</mapper>
