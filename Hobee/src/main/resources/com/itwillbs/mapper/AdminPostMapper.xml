<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminPostMapper">

    <!-- ============================================================
          ðŸ“Œ 1. ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ
    ============================================================ -->
    <select id="getPostDetail" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT 
            c.post_id,
            c.title,
            c.content,
            c.author,
            c.tag,
            c.views,
            c.is_visible,
            c.is_deleted,
            c.created_at,
            b.board_name
        FROM community_content c
        LEFT JOIN board_category b ON c.board_id = b.board_id
        WHERE c.post_id = #{post_id}
    </select>

    <!-- ============================================================
          ðŸ“Œ 2. ê²Œì‹œê¸€ ê³µê°œ/ìˆ¨ê¹€ í† ê¸€
    ============================================================ -->
    <update id="togglePostVisible">
        UPDATE community_content
        SET is_visible = CASE WHEN is_visible = 1 THEN 0 ELSE 1 END
        WHERE post_id = #{post_id}
          AND is_deleted = 0
    </update>

    <!-- ============================================================
          ðŸ“Œ 3. Soft Delete â€” ê²Œì‹œê¸€ ì‚­ì œ (is_deleted = 1)
    ============================================================ -->
    <update id="deletePost">
        UPDATE community_content
        SET is_deleted = 1
        WHERE post_id = #{post_id}
    </update>

    <!-- ============================================================
          ðŸ“Œ 4. ì „ì²´ ê²Œì‹œê¸€ ê°œìˆ˜ (ì‚­ì œëœ ê¸€ ì œì™¸)
    ============================================================ -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM community_content
        WHERE is_deleted = 0
    </select>

    <!-- ============================================================
          ðŸ“Œ 5. ê²Œì‹œê¸€ ëª©ë¡ (ì •ë ¬ + íŽ˜ì´ì§•)
    ============================================================ -->
    <select id="getPostListPagingSorted" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT
            c.post_id,
            c.title,
            c.author,
            c.content,
            c.tag,
            c.views,
            c.is_visible,
            c.created_at,
            b.board_name,
            (SELECT COUNT(*) FROM comment cm 
                WHERE cm.post_id = c.post_id AND cm.is_deleted = 0) AS reply_count
        FROM community_content c
        LEFT JOIN board_category b ON c.board_id = b.board_id
        WHERE c.is_deleted = 0

        <choose>
            <when test="sort == 'views'">
                ORDER BY c.views DESC
            </when>
            <when test="sort == 'reply'">
                ORDER BY reply_count DESC, c.post_id DESC
            </when>
            <when test="sort == 'visible'">
                ORDER BY c.is_visible DESC, c.post_id DESC
            </when>
            <otherwise>
                ORDER BY c.post_id DESC
            </otherwise>
        </choose>

        LIMIT #{start}, #{amount}
    </select>

    <!-- ============================================================
          ðŸ“Œ 6. ê²€ìƒ‰ + ì •ë ¬ + íŽ˜ì´ì§•
    ============================================================ -->
    <select id="getSearchPostListSorted" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT
            c.post_id,
            c.title,
            c.author,
            c.content,
            c.tag,
            c.views,
            c.is_visible,
            c.created_at,
            b.board_name,
            (SELECT COUNT(*) FROM comment cm 
                WHERE cm.post_id = c.post_id AND cm.is_deleted = 0) AS reply_count
        FROM community_content c
        LEFT JOIN board_category b ON c.board_id = b.board_id

        WHERE c.is_deleted = 0
        AND (
                (#{type} = 'T' AND c.title LIKE CONCAT('%', #{keyword}, '%'))
             OR (#{type} = 'A' AND c.author LIKE CONCAT('%', #{keyword}, '%'))
             OR (#{type} = 'B' AND b.board_name LIKE CONCAT('%', #{keyword}, '%'))
        )

        <choose>
            <when test="sort == 'views'">
                ORDER BY c.views DESC
            </when>
            <when test="sort == 'reply'">
                ORDER BY reply_count DESC, c.post_id DESC
            </when>
            <when test="sort == 'visible'">
                ORDER BY c.is_visible DESC, c.post_id DESC
            </when>
            <otherwise>
                ORDER BY c.post_id DESC
            </otherwise>
        </choose>

        LIMIT #{start}, #{amount}
    </select>

    <!-- ============================================================
          ðŸ“Œ 7. ê²€ìƒ‰ëœ ê²Œì‹œê¸€ ê°œìˆ˜
    ============================================================ -->
    <select id="getSearchTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM community_content c
        LEFT JOIN board_category b ON c.board_id = b.board_id
        WHERE c.is_deleted = 0
        AND (
                (#{type} = 'T' AND c.title LIKE CONCAT('%', #{keyword}, '%'))
             OR (#{type} = 'A' AND c.author LIKE CONCAT('%', #{keyword}, '%'))
             OR (#{type} = 'B' AND b.board_name LIKE CONCAT('%', #{keyword}, '%'))
        )
    </select>

    <!-- ============================================================
          ðŸ“Œ 8. ì¼ê´„ ìˆ¨ê¹€
    ============================================================ -->
    <update id="batchHide">
        UPDATE community_content
        SET is_visible = 0
        WHERE post_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- ============================================================
          ðŸ“Œ 9. ì¼ê´„ í‘œì‹œ
    ============================================================ -->
    <update id="batchShow">
        UPDATE community_content
        SET is_visible = 1
        WHERE post_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND is_deleted = 0
    </update>

    <!-- ============================================================
          ðŸ“Œ 10. ì¼ê´„ Soft Delete
    ============================================================ -->
    <update id="batchDelete">
        UPDATE community_content
        SET is_deleted = 1
        WHERE post_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- ============================================================
          ðŸ“Œ 11. Soft Delete ëœ ê²Œì‹œê¸€ë§Œ ì¡°íšŒ
    ============================================================ -->
    <select id="getDeletedPostList" resultType="com.itwillbs.domain.AdminPostVO">
        SELECT
            c.post_id,
            c.title,
            c.author,
            c.created_at,
            c.views,
            c.is_visible,
            b.board_name
        FROM community_content c
        LEFT JOIN board_category b ON c.board_id = b.board_id
        WHERE c.is_deleted = 1
        ORDER BY c.post_id DESC
    </select>

    <!-- ============================================================
          ðŸ“Œ 12. Soft Delete â†’ ë³µêµ¬
    ============================================================ -->
    <update id="restorePost">
        UPDATE community_content
        SET is_deleted = 0
        WHERE post_id = #{post_id}
    </update>

    <!-- ============================================================
          ðŸ“Œ 13. ê²Œì‹œê¸€ ìˆ˜ì •
    ============================================================ -->
    <update id="updatePost">
        UPDATE community_content
        SET 
            title = #{title},
            content = #{content},
            updated_at = NOW()
        WHERE post_id = #{post_id}
    </update>

    <!-- ============================================================
          ðŸ“Œ 14. ì¡°íšŒìˆ˜ TOP 10
    ============================================================ -->
    <select id="getTopViewPosts" resultType="map">
        SELECT
            title,
            views
        FROM community_content
        WHERE is_deleted = 0
        ORDER BY views DESC
        LIMIT 10
    </select>

    <!-- ============================================================
          ðŸ“Œ 15. ëŒ“ê¸€ ìˆ˜ TOP 10
    ============================================================ -->
    <select id="getTopCommentPosts" resultType="map">
        SELECT
            p.title AS title,
            COUNT(c.comment_id) AS comment_count
        FROM community_content p
        LEFT JOIN comment c 
            ON p.post_id = c.post_id AND c.is_deleted = 0
        WHERE p.is_deleted = 0
        GROUP BY p.post_id
        ORDER BY comment_count DESC
        LIMIT 10
    </select>

</mapper>
