<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminCommentMapper">

    <!-- ëŒ“ê¸€ ëª©ë¡ -->
    <select id="getPagingCommentList" resultType="com.itwillbs.domain.AdminCommentVO">
        SELECT
        c.comment_id,
        c.post_id,
        c.user_id,
        c.content,
        c.created_at,
        c.report_count,
        c.is_deleted,
        p.title AS post_title
        FROM comment c
        JOIN community_content p ON c.post_id = p.post_id
        WHERE 1 = 1

        <!-- ðŸ”¥ ìƒíƒœ í•„í„° -->
        <choose>
            <when test="status == 'deleted'">
                AND c.is_deleted = 1
            </when>
            <when test="status == 'normal'">
                AND c.is_deleted = 0
            </when>
            <otherwise>
                AND 1 = 1
            </otherwise>
        </choose>

        <!-- ðŸ” ê²€ìƒ‰ -->
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="type == 'title'">
                    AND p.title LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'userid'">
                    AND c.user_id LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'content'">
                    AND c.content LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </if>

        <!-- ðŸ”¥ ì •ë ¬ -->
        <choose>
            <when test="sort == 'report'">
                ORDER BY c.report_count DESC, c.comment_id DESC
            </when>
            <otherwise>
                ORDER BY c.comment_id DESC
            </otherwise>
        </choose>

        LIMIT #{cri.startRow}, #{cri.amount}
    </select>

    <!-- ì´ ê°œìˆ˜ -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM comment c
        JOIN community_content p ON c.post_id = p.post_id
        WHERE 1 = 1

        <choose>
            <when test="status == 'deleted'">
                AND c.is_deleted = 1
            </when>
            <when test="status == 'normal'">
                AND c.is_deleted = 0
            </when>
        </choose>

        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="type == 'title'">
                    AND p.title LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'userid'">
                    AND c.user_id LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'content'">
                    AND c.content LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </if>
    </select>

    <!-- ìƒì„¸ -->
    <select id="getCommentDetail" resultType="com.itwillbs.domain.AdminCommentVO">
        SELECT
        c.comment_id,
        c.post_id,
        c.user_id,
        c.content,
        c.created_at,
        c.report_count,
        c.is_deleted,
        p.title AS post_title
        FROM comment c
        JOIN community_content p ON c.post_id = p.post_id
        WHERE c.comment_id = #{comment_id}
    </select>

    <!-- ê°œë³„ ì‚­ì œ -->
    <update id="deleteComment">
        UPDATE comment
        SET is_deleted = 1
        WHERE comment_id = #{comment_id}
    </update>

    <!-- ì¼ê´„ ì‚­ì œ -->
    <update id="batchDelete">
        UPDATE comment
        SET is_deleted = 1
        WHERE comment_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- ë³µêµ¬ -->
    <update id="restoreComment">
        UPDATE comment
        SET is_deleted = 0
        WHERE comment_id = #{comment_id}
    </update>

</mapper>
