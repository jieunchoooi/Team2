<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.itwillbs.mapper.AdminCommentMapper">

    <!-- ================================= -->
    <!--   ëŒ“ê¸€ ëª©ë¡ (ì‹ ê³ ìˆ˜ + íŽ˜ì´ì§•)       -->
    <!-- ================================= -->
    <select id="getPagingCommentList" resultType="com.itwillbs.domain.AdminCommentVO">
        SELECT
        c.comment_id,
        c.post_id,
        c.user_num,
        c.content,
        c.created_at,
        c.is_deleted,
        u.user_name,
        p.title AS post_title,

        /* ðŸ”¥ community_report ê¸°ì¤€ ì‹¤ì‹œê°„ ì‹ ê³ ìˆ˜ */
        (SELECT COUNT(*)
        FROM community_report r
        WHERE r.comment_id = c.comment_id) AS report_count

        FROM community_comment c
        JOIN user u ON c.user_num = u.user_num
        JOIN community_content p ON c.post_id = p.post_id
        WHERE 1 = 1

        <!-- ìƒíƒœ í•„í„° -->
        <choose>
            <when test="status == 'deleted'">
                AND c.is_deleted = 1
            </when>
            <when test="status == 'normal'">
                AND c.is_deleted = 0
            </when>
        </choose>

        <!-- ê²€ìƒ‰ -->
        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="type == 'title'">
                    AND p.title LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'userid'">
                    AND u.user_name LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'content'">
                    AND c.content LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </if>

        <!-- ì •ë ¬ -->
        <choose>
            <when test="sort == 'report'">
                ORDER BY report_count DESC, c.comment_id DESC
            </when>
            <otherwise>
                ORDER BY c.comment_id DESC
            </otherwise>
        </choose>

        LIMIT #{cri.startRow}, #{cri.amount}
    </select>


    <!-- ================================= -->
    <!--   ì´ ëŒ“ê¸€ ê°œìˆ˜                    -->
    <!-- ================================= -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM community_comment c
        JOIN community_content p ON c.post_id = p.post_id
        WHERE 1 = 1

        <choose>
            <when test="status == 'deleted'">
                AND c.is_deleted = 1
            </when>
            <when test="status == 'normal'">
                AND c.is_deleted = 0
            </when>
        </choose>

        <if test="keyword != null and keyword != ''">
            <choose>
                <when test="type == 'title'">
                    AND p.title LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'userid'">
                    AND u.user_name LIKE CONCAT('%', #{keyword}, '%')
                </when>
                <when test="type == 'content'">
                    AND c.content LIKE CONCAT('%', #{keyword}, '%')
                </when>
            </choose>
        </if>
    </select>


    <!-- ================================= -->
    <!--   ëŒ“ê¸€ ìƒì„¸ ì¡°íšŒ (ì‹ ê³ ìˆ˜ í¬í•¨)      -->
    <!-- ================================= -->
    <select id="getCommentDetail" resultType="com.itwillbs.domain.AdminCommentVO">
        SELECT
        c.comment_id,
        c.post_id,
        c.user_num,
        c.content,
        c.created_at,
        c.is_deleted,
        u.user_name,
        p.title AS post_title,

        /* ðŸ”¥ community_report ê¸°ì¤€ ì‹ ê³ ìˆ˜ */
        (SELECT COUNT(*)
        FROM community_report r
        WHERE r.comment_id = c.comment_id) AS report_count

        FROM community_comment c
        JOIN user u ON c.user_num = u.user_num
        JOIN community_content p ON c.post_id = p.post_id
        WHERE c.comment_id = #{comment_id}
    </select>


    <!-- ================================= -->
    <!--   ì‚­ì œ / ë³µêµ¬                      -->
    <!-- ================================= -->
    <update id="deleteComment">
        UPDATE community_comment
        SET is_deleted = 1
        WHERE comment_id = #{comment_id}
    </update>

    <update id="batchDelete">
        UPDATE community_comment
        SET is_deleted = 1
        WHERE comment_id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="restoreComment">
        UPDATE community_comment
        SET is_deleted = 0
        WHERE comment_id = #{comment_id}
    </update>


    <!-- ================================= -->
    <!--   ëŒ“ê¸€ ì‹ ê³  ë‚´ì—­ ì¡°íšŒ              -->
    <!-- ================================= -->
    <select id="getCommentReportList" resultType="com.itwillbs.domain.CommentReportVO">
        SELECT
        report_id,
        post_id,
        comment_id,
        reporter_id,
        reason,
        created_at,
        is_done,
        done_at,
        done_reason
        FROM community_report
        WHERE comment_id = #{comment_id}
        ORDER BY report_id DESC
    </select>


    <!-- ================================= -->
    <!--   ê´€ë¦¬ìž ì•¡ì…˜ ë¡œê·¸                 -->
    <!-- ================================= -->
    <insert id="insertActionLog">
        INSERT INTO admin_action_log (comment_id, admin_id, action, reason)
        VALUES (#{comment_id}, #{admin_id}, #{action}, #{reason})
    </insert>

    <select id="getCommentActionLogs" resultType="com.itwillbs.domain.AdminActionLogVO">
        SELECT
        log_id,
        comment_id,
        admin_id,
        action,
        reason,
        created_at
        FROM admin_action_log
        WHERE comment_id = #{comment_id}
        ORDER BY log_id DESC
    </select>


    <!-- ================================= -->
    <!--   ê²Œì‹œê¸€ ìƒì„¸ â€“ ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸        -->
    <!-- ================================= -->
    <select id="getCommentsByPostId" resultType="com.itwillbs.domain.AdminCommentVO">
        SELECT
        c.comment_id,
        c.post_id,
        c.user_num,
        c.content,
        c.created_at,
        c.is_deleted,

        /* ðŸ”¥ community_report ê¸°ì¤€ ì‹ ê³ ìˆ˜ */
        (SELECT COUNT(*)
        FROM community_report r
        WHERE r.comment_id = c.comment_id) AS report_count

        FROM community_comment c
        WHERE post_id = #{post_id}
        ORDER BY c.comment_id DESC
    </select>

</mapper>
